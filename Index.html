<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MAGOG IDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.min.css">

    

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/jsx/jsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/clike/clike.min.js"></script> 

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/php/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/ruby/ruby.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/go/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>
    
    

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/css-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/comment-fold.min.js"></script>

    <style>
        :root { --header-height: 4rem; --footer-height: 3.5rem; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #000; }
        .view { display: none; height: 100%; }
        .view.active { display: flex; flex-direction: column; }
        .main-content { height: calc(100vh - var(--header-height) - var(--footer-height)); }
        @media (min-width: 768px) { .main-content { height: calc(100vh - var(--header-height)); } }
        .CodeMirror { height: 100%; font-size: 14px; border-radius: 0.5rem; background: transparent; }
        .file-item-container, .folder-item-container { transition: background-color: 0.2s; }
        .file-item-container:hover, .folder-item-container:hover { background-color: rgba(255, 255, 255, 0.1); }
        .file-item-container.selected, .folder-item-container.selected { background-color: rgba(255, 255, 255, 0.2); }
        .folder-content { padding-left: 1.25rem; border-left: 1px solid rgba(255, 255, 255, 0.2); margin-left: 0.625rem;}
        .bottom-nav-btn.active { color: #ffffff; border-top-color: #ffffff; }
        .context-menu { position: fixed; z-index: 1000; border-radius: 0.5rem; }
        .context-menu-item { padding: 0.75rem 1.25rem; cursor: pointer; color: white; display: flex; align-items: center; white-space: nowrap; }
        .context-menu-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .context-menu-item.delete { color: #f87171; }
        .context-menu-divider { height: 1px; background-color: rgba(255, 255, 255, 0.2); margin: 0.25rem 0; }
        .folder-arrow { transition: transform 0.2s; }
        .folder-arrow.rotate-90 { transform: rotate(90deg); }
        .project-card, .hub-card { transition: transform 0.2s, box-shadow 0.2s; }
        .project-card:hover, .hub-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(255, 255, 255, 0.1), 0 4px 6px -2px rgba(255, 255, 255, 0.05); }
        .item-menu-btn { color: #9ca3af; }
        .item-menu-btn:hover { color: white; }
        .git-file-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; border-radius: 0.375rem; background-color: rgba(255,255,255,0.05); }
        .git-file-item:hover { background-color: rgba(255,255,255,0.1); }
        .git-action-btn { background-color: transparent; border: none; color: #9ca3af; cursor: pointer; padding: 0.25rem; }
        .git-action-btn:hover { color: white; }
        .glassmorphism {
            background: rgba(10, 10, 10, 0.5); 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .ai-message { padding: 0.75rem; border-radius: 0.5rem; max-width: 85%; }
        .ai-message.user { background-color: rgba(255, 255, 255, 0.2); align-self: flex-end; }
        .ai-message.assistant { background-color: rgba(255, 255, 255, 0.1); align-self: flex-start; }
        .ai-message pre { white-space: pre-wrap; word-wrap: break-word; }
        .CodeMirror-hints {
            background-color: #111 !important;
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }
        .CodeMirror-hint-active {
            background-color: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }
        .search-result-item { cursor: pointer; }
        .search-result-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .search-result-item .match { background-color: #ffffff; color: #000; font-weight: bold; }
        .asset-svg-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 0.5rem; }
        .asset-svg-wrapper svg { width: 100%; height: 100%; object-fit: contain; }
        .delete-asset-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(0,0,0,0.5); border-radius: 9999px; padding: 0.25rem; display: none; }
        .group:hover .delete-asset-btn { display: block; }
        .delete-asset-btn:hover { background-color: rgba(239, 68, 68, 0.8); }
        #focusModeView {
            position: fixed; inset: 0; z-index: 100;
            background-color: #000;
        }
        #focusEditorWrapper { height: 100%; width: 100%; }
        .focus-ui-popup {
            position: fixed;
            background-color: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            z-index: 110;
            animation: fadeIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
            max-width: 90vw;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        #exitFocusBtn {
            position: fixed; bottom: 1rem; right: 1rem; z-index: 120;
        }
        #tabBar {
            scrollbar-width: thin;
            scrollbar-color: #555 #333;
        }
        #tabBar::-webkit-scrollbar { width: 4px; height: 4px; }
        #tabBar::-webkit-scrollbar-track { background: transparent; }
        #tabBar::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }

        .tab-item {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-right: 1px solid #1f2937; /* gray-800 */
            color: #9ca3af; /* gray-400 */
            font-size: 0.875rem;
            background-color: #111827; /* gray-900 */
        }
        .tab-item:hover {
            background-color: #1f2937; /* gray-800 */
        }
        .tab-item.active {
            background-color: transparent;
            color: white;
            border-bottom: 2px solid transparent;
        }
        .tab-close-btn {
            margin-left: 0.75rem;
            padding: 0.125rem;
            border-radius: 9999px;
            line-height: 1;
            transition: background-color: 0.2s;
        }
        .tab-close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* General UI Tweaks */
        .btn-primary {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .input-field {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .input-field:focus {
            ring: 1px solid white;
            border-color: white;
        }

    </style>
</head>
<body class="bg-black text-white h-screen flex flex-col items-center justify-center p-0">
    <input type="file" id="fileUploader" class="hidden" accept=".html,.css,.js,.jsx,.py,.java,.c,.cpp,.cs,.php,.rb,.go,.sql,.json,.txt,.md,.doc,.docx,.pdf">
    <input type="file" id="storageUploader" class="hidden" multiple>
    <input type="file" id="assetUploader" class="hidden" accept="image/*,.svg,.json,.txt,.md">

    

<div id="authView" class="view w-full h-full items-center justify-center" style="background-image: url(); background-size: cover; background-position: center;">
         <div class="glassmorphism rounded-none md:rounded-2xl shadow-2xl p-8 w-full h-full md:h-auto md:max-w-md flex flex-col justify-center">
            <div class="mb-8 text-center"><h2 class="text-3xl font-bold">Welcome to MAGOG</h2></div>
            <div class="flex border-b border-gray-700 mb-6">
                <button id="loginSwitch" class="form-switch-btn flex-1 py-2 text-gray-400 font-medium">Login</button>
                <button id="registerSwitch" class="form-switch-btn flex-1 py-2 text-gray-400 font-medium">Register</button>
            </div>
            <form id="loginForm" class="space-y-6">
                <div><label for="loginEmail" class="block text-sm font-medium text-gray-300">Email</label><input type="email" id="loginEmail" required class="mt-1 block w-full input-field rounded-md p-3 focus:ring-white focus:border-white"></div>
                <div><label for="loginPassword" class="block text-sm font-medium text-gray-300">Password</label><input type="password" id="loginPassword" required class="mt-1 block w-full input-field rounded-md p-3 focus:ring-white focus:border-white"></div>
                <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Login</button>
            </form>
            <form id="registerForm" class="space-y-6 hidden">
                <div><label for="registerEmail" class="block text-sm font-medium text-gray-300">Email</label><input type="email" id="registerEmail" required class="mt-1 block w-full input-field rounded-md p-3 focus:ring-white focus:border-white"></div>
                <div><label for="registerPassword" class="block text-sm font-medium text-gray-300">Password</label><input type="password" id="registerPassword" required class="mt-1 block w-full input-field rounded-md p-3 focus:ring-white focus:border-white"></div>
                <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Create Account</button>
            </form>
            <div id="authMessageBox" class="mt-4 text-center text-sm text-red-400"></div>
            <div class="mt-4 border-t border-gray-700 pt-4 text-center">
                <button id="devLoginBtn" class="text-gray-400 hover:text-white hover:underline text-sm font-medium">Quick Dev Login</button>
            </div>
         </div>
    </div>

    

<div id="homeView" class="view w-full h-full overflow-y-auto bg-black">
        <div class="w-full max-w-6xl mx-auto flex flex-col justify-center min-h-full p-4">
            <header class="text-center mb-12">
                <h1 class="text-5xl font-extrabold tracking-tight text-white sm:text-6xl">MAGOG</h1>
                <p class="mt-4 text-lg text-gray-400">Your Development Command Center</p>
            </header>
            <main class="grid grid-cols-1 sm:grid-cols-2 gap-8 justify-center">
                <div id="hubEditorBtn" class="hub-card glassmorphism rounded-2xl p-8 cursor-pointer hover:border-white flex flex-col items-center text-center">
                    <img src="https://raw.githubusercontent.com/juugboytv/MagogogoStu/refs/heads/main/IMG_3900.jpeg" alt="Code Editor Icon" class="w-20 h-20 rounded-full mb-4 object-cover border-2 border-gray-500">
                    <h2 class="text-2xl font-bold">Code Editor</h2>
                    <p class="text-gray-400 mt-2">Open your projects and build with the full-featured IDE.</p>
                </div>
                <div id="hubStorageBtn" class="hub-card glassmorphism rounded-2xl p-8 cursor-pointer hover:border-white flex flex-col items-center text-center">
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-20 h-20 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                    <h2 class="text-2xl font-bold">Geminus Storage</h2>
                    <p class="text-gray-400 mt-2">Store notes, code, files, and game assets.</p>
                </div>
                 <div id="hubCanvasIframeBtn" class="hub-card glassmorphism rounded-2xl p-8 cursor-pointer hover:border-white flex flex-col items-center text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-20 h-20 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                    <h2 class="text-2xl font-bold">Canvas Iframe</h2>
                    <p class="text-gray-400 mt-2">A dedicated space for your creations.</p>
                </div>
                <div id="hubToolsBtn" class="hub-card glassmorphism rounded-2xl p-8 cursor-pointer hover:border-white flex flex-col items-center text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-20 h-20 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <h2 class="text-2xl font-bold">Tools</h2>
                    <p class="text-gray-400 mt-2">Explore development utilities and helpers.</p>
                </div>
            </main>
             <footer class="text-center mt-12">
                <button id="logoutBtn" class="text-gray-500 hover:text-white">Logout</button>
            </footer>
        </div>
    </div>
    
    

<div id="dashboardView" class="view w-full h-full bg-black">
        <header class="glassmorphism p-4 flex justify-between items-center flex-shrink-0">
             <div class="flex items-center">
                 <button id="dashboardBackBtn" class="p-2 rounded-full hover:bg-gray-700 mr-2" title="Back to Home"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 id="dashboardTitle" class="text-2xl font-bold">My Projects</h1>
            </div>
            <div id="dashboardActions" class="flex items-center space-x-4">
                <button id="uploadStorageBtn" class="btn-primary font-bold py-2 px-4 rounded-lg flex items-center hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>Upload File</button>
                <button id="newItemBtn" class="btn-primary font-bold py-2 px-4 rounded-lg flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>New Project</button>
            </div>
        </header>
        <main id="itemList" class="flex-grow p-4 md:p-8 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></main>
    </div>

    

<div id="editorView" class="view w-full h-full bg-black">
        <header class="glassmorphism p-3 flex justify-between items-center h-[var(--header-height)] flex-shrink-0">
            <div class="flex items-center">
                <button id="backToDashboardBtn" class="p-2 rounded-full hover:bg-gray-700 mr-2" title="Back to Dashboard"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 id="headerTitle" class="text-xl font-bold truncate"></h1>
            </div>
            <div id="headerActions" class="flex items-center space-x-3">
                 <button id="manageLibrariesBtn" class="p-2 rounded-full hover:bg-gray-700" title="Manage JS Libraries"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg></button>
                 <button id="focusModeBtn" class="p-2 rounded-full hover:bg-gray-700" title="Enter Focus Mode"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" /></svg></button>
                <button id="runButton" class="p-2 rounded-full hover:bg-gray-700" title="Run Project"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                <button id="saveButton" class="btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200">Save</button>
            </div>
        </header>
        <main class="main-content flex-grow flex md:flex-row flex-col overflow-hidden">
            <div id="fileExplorerPanel" class="glassmorphism p-2 overflow-y-auto h-full w-full md:w-64 md:flex-shrink-0">
                 <div class="flex justify-end items-center mb-2 p-2 space-x-2">
                    <button id="uploadFileBtn" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-md" title="Upload File"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></button>
                    <button id="newFileBtn" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-md" title="New File"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></button>
                    <button id="newFolderBtn" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-md" title="New Folder"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg></button>
                </div>
                <div id="fileTree"></div>
            </div>
            <div id="editorPanel" class="flex-col md:flex-1 h-full w-full hidden md:flex">
                <div id="tabBar" class="flex-shrink-0 border-b border-gray-800 overflow-x-auto"></div>
                <div id="editorWrapper" class="flex-grow relative h-full hidden">
                    <textarea id="codeEditor"></textarea>
                </div>
                <div id="editorPlaceholder" class="w-full h-full flex items-center justify-center text-gray-500">
                    Select a file from the explorer to begin editing.
                </div>
            </div>
            <div id="previewPanel" class="bg-white h-full w-full hidden md:flex md:flex-1"><iframe id="previewFrame" class="w-full h-full border-none" sandbox="allow-scripts allow-same-origin"></iframe></div>
            <div id="assetsPanel" class="glassmorphism p-4 overflow-y-auto h-full w-full hidden md:flex md:flex-col">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Project Assets</h2>
                    <div class="flex space-x-2">
                        <button id="newAssetFolderBtn" class="btn-primary font-bold py-2 px-4 rounded-lg">New Folder</button>
                        <button id="uploadAssetBtn" class="btn-primary font-bold py-2 px-4 rounded-lg">Upload</button>
                    </div>
                </div>
                <div id="assetList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            <div id="aiPanel" class="glassmorphism p-4 h-full w-full hidden md:flex md:flex-col">
                <h2 class="text-xl font-bold mb-4 flex-shrink-0">AI Assistant</h2>
                <div id="aiChatContainer" class="flex-grow overflow-y-auto mb-4 space-y-4 flex flex-col pr-2"></div>
                <div class="flex-shrink-0 space-y-2">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <button class="ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Explain the selected code.">Explain Code</button>
                        <button class="ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Find potential bugs in the selected code.">Find Bugs</button>
                        <button class="ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Optimize the selected code.">Optimize</button>
                        <button class="ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Add comments to the selected code.">Add Comments</button>
                    </div>
                    <div class="flex items-center">
                        <input type="text" id="aiInput" class="w-full input-field rounded-l-md p-3" placeholder="Ask the AI assistant...">
                        <button id="aiSendBtn" class="btn-primary font-bold p-3 rounded-r-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="searchPanel" class="glassmorphism p-4 h-full w-full hidden md:flex md:flex-col">
                 <h2 class="text-xl font-bold mb-4 flex-shrink-0">Project Search</h2>
                <div class="flex items-center mb-4">
                    <input type="text" id="searchInput" class="w-full input-field rounded-l-md p-3" placeholder="Search across all files...">
                    <button id="searchBtn" class="btn-primary font-bold p-3 rounded-r-md">Search</button>
                </div>
                <div id="searchResults" class="flex-grow overflow-y-auto pr-2"></div>
            </div>
             <div id="snippetsPanel" class="glassmorphism p-4 h-full w-full hidden md:flex md:flex-col">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Code Snippets</h2>
                    <button id="newSnippetBtn" class="btn-primary font-bold py-2 px-4 rounded-lg">New Snippet</button>
                </div>
                <div id="snippetList" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
            </div>
            <div id="gitPanel" class="glassmorphism p-4 overflow-y-auto h-full w-full hidden md:flex md:flex-col">
                 <h2 class="text-xl font-bold mb-4 flex-shrink-0">Git Control</h2>
                <div id="gitConnectView">
                    <h3 class="text-lg font-semibold mb-2">Connect to GitHub</h3>
                    <p class="text-sm text-gray-400 mb-4">Enter a <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" class="text-gray-300 hover:underline">Personal Access Token</a> to connect your account.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="githubPat" class="block text-sm font-medium text-gray-300">Personal Access Token (PAT)</label>
                            <input type="password" id="githubPat" class="mt-1 block w-full input-field rounded-md p-3" placeholder="ghp_...">
                        </div>
                        <button id="connectGitBtn" class="w-full btn-primary font-bold py-3 rounded-lg">Connect</button>
                    </div>
                </div>
                <div id="gitMainView" class="hidden flex flex-col h-full">
                     <div class="flex justify-between items-center mb-4 flex-shrink-0">
                         <div class="flex items-center">
                            <img id="githubAvatar" class="h-10 w-10 rounded-full mr-3">
                            <div>
                                <p class="font-semibold">Connected as</p>
                                <p id="githubUsername" class="text-gray-300"></p>
                            </div>
                        </div>
                        <button id="disconnectGitBtn" class="bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-4 rounded-lg">Disconnect</button>
                    </div>
                    <div class="mb-4 flex-shrink-0">
                        <label for="repoSelect" class="block text-sm font-medium text-gray-300">Repository</label>
                        <select id="repoSelect" class="mt-1 block w-full input-field rounded-md p-2">
                            <option>Select a repository...</option>
                        </select>
                    </div>
                    <div id="gitActionButtons" class="mb-4 flex space-x-2">
                        <button id="pullBtn" class="flex-1 btn-primary font-bold py-2 rounded-lg">Pull</button>
                        <button id="pushBtn" class="flex-1 btn-primary font-bold py-2 rounded-lg">Push</button>
                    </div>
                    <div class="flex-grow overflow-y-auto space-y-4 pr-2">
                        <div>
                            <h4 class="text-sm font-bold uppercase text-gray-400 mb-2">Changes</h4>
                            <div id="gitChangesList" class="space-y-2"></div>
                        </div>
                         <div>
                            <h4 class="text-sm font-bold uppercase text-gray-400 mb-2">Staged Changes</h4>
                            <div id="gitStagedList" class="space-y-2"></div>
                        </div>
                         <div>
                            <h4 class="text-sm font-bold uppercase text-gray-400 mb-2">Commit History</h4>
                            <div id="commitHistory" class="space-y-2 text-gray-500 text-sm">
                                <p>Commit history will appear here...</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 border-t border-gray-700 pt-4 flex-shrink-0">
                        <textarea id="commitMessage" class="w-full input-field rounded-md p-2 mb-2" placeholder="Commit message..." rows="2"></textarea>
                        <button id="commitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg">Commit</button>
                    </div>
                </div>
            </div>
        </main>
        <nav class="glassmorphism flex justify-around items-center h-[var(--footer-height)] flex-shrink-0 md:hidden"></nav>
    </div>

    

<div id="canvasView" class="view w-full h-full bg-gray-800">
        <header class="glassmorphism p-4 flex justify-between items-center flex-shrink-0 h-[var(--header-height)]">
            <div class="flex items-center">
                <button id="canvasBackBtn" class="p-2 rounded-full hover:bg-gray-700 mr-2" title="Back to Home"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 class="text-2xl font-bold">Canvas</h1>
            </div>
             <div class="flex items-center space-x-4">
                 <input type="url" id="canvasUrlInput" class="input-field rounded-md p-2 w-64" placeholder="Enter URL to load...">
                <button id="loadCanvasUrlBtn" class="btn-primary font-bold py-2 px-4 rounded-lg">Load</button>
            </div>
        </header>
        <main class="flex-grow bg-white">
            <iframe id="canvasIframe" class="w-full h-full border-none"></iframe>
        </main>
    </div>

    

<div id="toolsView" class="view w-full h-full bg-gray-900">
        <header class="glassmorphism p-4 flex justify-between items-center flex-shrink-0 h-[var(--header-height)]">
            <div class="flex items-center">
                <button id="toolsBackBtn" class="p-2 rounded-full hover:bg-gray-700 mr-2" title="Back to Home"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 class="text-2xl font-bold">Developer Tools</h1>
            </div>
        </header>
        <main class="flex-grow bg-gray-800">
            <iframe id="toolsIframe" class="w-full h-full border-none"></iframe>
        </main>
    </div>


    

<div id="focusModeView" class="hidden">
        <div id="focusEditorWrapper"></div>
        <button id="exitFocusBtn" class="btn-primary p-2 rounded-full text-white" title="Exit Focus Mode">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>
    
    

<div id="modalContainer" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"></div>
    <div id="contextMenu" class="context-menu glassmorphism hidden"></div>

    <script type="module">
        // Firebase Modular SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, getDoc, getDocs, serverTimestamp, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const maGOGSuiteHTML = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
                <title>maGOG Suite</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">

                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                    
                    :root { 
                        --header-height: 4.5rem; 
                        --console-height: 150px; 
                        --tabs-height: 2.5rem; 
                    }
                    
                    html, body {
                        height: 100%; width: 100%; overflow: hidden; position: fixed;
                        font-family: 'Inter', sans-serif;
                        background-color: #131314;
                        background-image: radial-gradient(circle at top left, rgba(121, 82, 179, 0.08), transparent 40%),
                                          radial-gradient(circle at bottom right, rgba(82, 179, 121, 0.08), transparent 40%);
                    }
                    
                    #main-content-container { height: calc(100vh - var(--header-height)); }
                    #ide-main-content { height: 100%; }

                    #console-panel { position: absolute; bottom: 0; left: 0; right: 0; height: var(--console-height); background-color: #1e1f22; border-top: 1px solid #3c4043; z-index: 30; transform: translateY(100%); transition: transform 0.3s ease; }
                    #console-panel.active { transform: translateY(0); }
                    #console-header { display: flex; align-items: center; justify-content: space-between; padding: 2px 8px; background-color: #2a2b2e; border-bottom: 1px solid #3c4043;}
                    #console-content { height: calc(100% - 25px); overflow-y: auto; padding: 0.5rem; font-family: monospace; font-size: 0.8rem; color: #e0e0e0; }
                    .console-log, .console-error, .console-warn { border-bottom: 1px solid #2a2b2e; padding: 2px 4px; white-space: pre-wrap; word-break: break-all; }
                    .console-error { color: #ff8a80; font-weight: bold; }
                    .console-warn { color: #ffd180; }
                    
                    .ide-view-panel { transition: transform 0.3s ease-in-out; }
                    .hidden-view { transform: translateX(100%); }
                    .hidden-view.editor-view { transform: translateX(-100%); }
                    
                    #editor-wrapper { display: flex; flex-direction: column; height: 100%; padding: 0 0.5rem 0.5rem 0.5rem; position: relative; }
                    #file-tabs { height: var(--tabs-height); background-color: transparent; display: flex; flex-shrink: 0; align-items: center; overflow-x: auto; scrollbar-width: none; }
                    #file-tabs::-webkit-scrollbar { display: none; }
                    .file-tab { padding: 0 0.5rem 0 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem; color: #9aa0a6; border-top-left-radius: 6px; border-top-right-radius: 6px; transition: background-color 0.2s, color 0.2s; height: 100%; flex-shrink: 0; }
                    .file-tab.active { background-color: rgba(30, 31, 34, 0.75); color: #f8f8f2; font-weight: 500; border-top: 1px solid rgba(255, 255, 255, 0.1); border-left: 1px solid rgba(255, 255, 255, 0.1); border-right: 1px solid rgba(255, 255, 255, 0.1); }
                    .close-tab-btn { background: transparent; border: none; color: #9aa0a6; font-weight: bold; padding: 0.25rem; line-height: 1; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
                    .close-tab-btn:hover { background-color: rgba(255,255,255,0.1); color: white; }
                    #editor-container { flex-grow: 1; overflow: hidden; position: relative; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }

                    .CodeMirror.cm-s-dracula {
                        background-color: rgba(30, 31, 34, 0.75) !important;
                        backdrop-filter: blur(16px) saturate(150%);
                        -webkit-backdrop-filter: blur(16px) saturate(150%);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        height: 100%; width: 100%; font-size: 14px;
                        border-bottom-left-radius: 8px;
                        border-bottom-right-radius: 8px;
                    }

                    #empty-state-container { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9aa0a6; text-align: center; background-color: rgba(30, 31, 34, 0.75); backdrop-filter: blur(16px) saturate(150%); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); }
                    .empty-state-btn { background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 0.75rem 1.5rem; border-radius: 6px; transition: all 0.2s ease; }
                    .empty-state-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); color: #fff; }
                    
                    .ide-sub-toggle { display: flex; align-items: center; background-color: #202124; border-radius: 9999px; border: 1px solid #4d4e50; padding: 2px; }
                    .ide-sub-toggle-button { transition: background-color 0.3s ease, color 0.3s ease; }
                    .ide-sub-toggle-button.active-toggle { background-color: #1a73e8; color: white; }
                    .header-button { transition: color 0.2s, transform 0.1s; flex-shrink: 0; }
                    .header-button:active { transform: scale(0.9); }
                    
                    #loading-overlay { position: absolute; inset: 0; background-color: #282a36; z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s ease; }
                    .spinner { width: 40px; height: 40px; border: 4px solid #44475a; border-top-color: #bd93f9; border-radius: 50%; animation: spin 1s linear infinite; }
                    @keyframes spin { to { transform: rotate(360deg); } }

                    /* Storage View Styles */
                    #storage-view { padding: 1.5rem; color: #e0e0e0; max-width: 800px; margin: 0 auto; }
                    .storage-card { background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
                    .storage-input { background-color: #2a2b2e; border: 1px solid #4d4e50; border-radius: 6px; padding: 0.5rem 0.75rem; width: 100%; color: white; }
                    .storage-btn { background-color: #1a73e8; color: white; padding: 0.5rem 1rem; border-radius: 6px; transition: background-color 0.2s; border: none; cursor: pointer;}
                    .storage-btn:hover { background-color: #1b66c9; }
                    .storage-project-list { list-style: none; padding: 0; }
                    .storage-project-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background-color: rgba(255, 255, 255, 0.02); border-radius: 6px; margin-bottom: 0.5rem; }
                    .storage-btn-danger { background-color: #da3633; }
                    .storage-btn-danger:hover { background-color: #b92521; }

                </style>
            </head>
            <body class="text-gray-200">
                <div id="app-container" class="flex flex-col h-screen w-screen">
                    <header class="bg-transparent h-[var(--header-height)] flex-shrink-0 flex items-center justify-between px-3 z-20 border-b border-gray-700/50 gap-4">
                        <div class="flex items-center gap-2">
                            <button data-action="undo" title="Undo" class="header-button p-1.5 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3"/></svg></button>
                            <button data-action="redo" title="Redo" class="header-button p-1.5 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3"/></svg></button>
                            <div class="h-6 w-px bg-gray-600 mx-1"></div>
                            <button data-action="upload" title="Upload Files" class="header-button p-1.5 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button>
                            <button data-action="download" title="Download Active File" class="header-button p-1.5 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                            <div class="h-6 w-px bg-gray-600 mx-1"></div>
                            <button data-action="ai-assistant" title="AI Assistant" class="header-button p-1.5 text-purple-400 hover:text-purple-300"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2 18.16V22h3.84l14.8-14.8a1.21 1.21 0 0 0 0-1.72z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M3 8h4"/><path d="M19 14v4"/><path d="M17 16h4"/></svg></button>
                        </div>
                        
                        <div class="ide-sub-toggle">
                            <button data-action="switch-view" data-view="code" class="ide-sub-toggle-button px-3 py-2 text-sm font-medium rounded-full">Code</button>
                            <button data-action="switch-view" data-view="preview" class="ide-sub-toggle-button px-3 py-2 text-sm font-medium rounded-full">Preview</button>
                            <button data-action="switch-view" data-view="storage" class="ide-sub-toggle-button px-3 py-2 text-sm font-medium rounded-full">Storage</button>
                        </div>
                    </header>

                    <div id="main-content-container" class="relative flex-grow overflow-hidden">
                         <main id="ide-main-content" class="relative">
                            <div id="ide-editor-panel" class="ide-view-panel editor-view absolute inset-0">
                                <div id="editor-wrapper">
                                    <div id="file-tabs"></div>
                                    <div id="editor-container">
                                         <div id="loading-overlay"><div class="spinner"></div></div>
                                         <div id="empty-state-container">
                                            <h2 class="text-xl font-semibold mb-2">Workspace Empty</h2>
                                            <p class="mb-6">Start by creating a new project or uploading files.</p>
                                            <div class="flex flex-wrap justify-center gap-4">
                                                 <button data-action="create-project" class="empty-state-btn">New Project (HTML/CSS/JS)</button>
                                                 <button data-action="upload" class="empty-state-btn">Upload Files</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="ide-preview-panel" class="ide-view-panel preview-view absolute inset-0 hidden-view bg-white">
                                <iframe id="preview-frame" class="w-full h-full border-none" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
                            </div>
                            <div id="ide-storage-panel" class="ide-view-panel storage-view absolute inset-0 hidden-view overflow-y-auto">
                                <div id="storage-view">
                                    <div class="storage-card">
                                        <h2 class="text-xl font-semibold mb-4">Save Current Project</h2>
                                        <div class="flex flex-col sm:flex-row gap-4">
                                            <input type="text" id="project-name-input" class="storage-input flex-grow" placeholder="Enter project name...">
                                            <button id="save-project-btn" class="storage-btn">Save Project</button>
                                        </div>
                                    </div>
                                    <div class="storage-card">
                                        <h2 class="text-xl font-semibold mb-4">Load Existing Project</h2>
                                        <ul id="project-list" class="storage-project-list">
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </main>
                        <div id="console-panel">
                            <div id="console-header">
                                <button data-action="toggle-console" title="Toggle Console" class="header-button p-1.5 text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg></button>
                                <button data-action="clear-console" title="Clear console" class="text-gray-400 hover:text-white transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                </button>
                            </div>
                            <div id="console-content"></div>
                        </div>
                    </div>
                    
                    <input type="file" id="upload-input" class="hidden" accept=".html,.js,.css" multiple>
                    <div id="toast-notification" class="fixed bottom-[-100px] left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-4 rounded-lg z-[100] transition-all duration-300"></div>
                    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-11/12 max-w-md">
                            <h3 id="modal-title" class="text-lg font-medium mb-4"></h3>
                            <div id="modal-content" class="mb-6"></div>
                            <div id="modal-buttons" class="flex justify-end space-x-3"></div>
                        </div>
                    </div>
                </div>
                
                <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"><\/script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"><\/script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"><\/script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"><\/script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"><\/script>
                
                <script type="module">
                    const dom = {
                        loadingOverlay: document.getElementById('loading-overlay'),
                        uploadInput: document.getElementById('upload-input'),
                        ideEditorPanel: document.getElementById('ide-editor-panel'),
                        idePreviewPanel: document.getElementById('ide-preview-panel'),
                        ideStoragePanel: document.getElementById('ide-storage-panel'),
                        editorContainer: document.getElementById('editor-container'),
                        fileTabsContainer: document.getElementById('file-tabs'),
                        previewFrame: document.getElementById('preview-frame'),
                        consolePanel: document.getElementById('console-panel'),
                        consoleContent: document.getElementById('console-content'),
                        emptyStateContainer: document.getElementById('empty-state-container'),
                        toast: document.getElementById('toast-notification'),
                        projectNameInput: document.getElementById('project-name-input'),
                        saveProjectBtn: document.getElementById('save-project-btn'),
                        projectList: document.getElementById('project-list'),
                    };

                    let codeMirrorEditor, activeFile = null, files = {}; 

                    const showModal = (title, content, buttons) => {
                        document.getElementById('modal-title').innerHTML = title;
                        document.getElementById('modal-content').innerHTML = content;
                        const buttonsContainer = document.getElementById('modal-buttons');
                        buttonsContainer.innerHTML = '';
                        buttons.forEach(b => {
                            const btn = document.createElement('button');
                            btn.className = b.class;
                            btn.textContent = b.text;
                            btn.onclick = (e) => b.onClick(e.currentTarget);
                            buttonsContainer.appendChild(btn);
                        });
                        document.getElementById('modal-container').classList.remove('hidden');
                    };

                    const closeModal = () => {
                        document.getElementById('modal-container').classList.add('hidden');
                    };

                    const debounce = (func, delay) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); } };
                    const showToast = (message) => { dom.toast.textContent = message; dom.toast.style.bottom = '20px'; setTimeout(() => { dom.toast.style.bottom = '-100px'; }, 2500); };
                    
                    const getModeFromFilename = (filename = '') => {
                        const ext = filename.split('.').pop();
                        const modes = { html: { mode: 'xml', mime: 'text/html' }, css: { mode: 'css', mime: 'text/css' }, js: { mode: 'javascript', mime: 'application/javascript' } };
                        return modes[ext] || { mode: 'null', mime: 'text/plain' };
                    };

                    const initCodeMirror = () => {
                        codeMirrorEditor = CodeMirror(dom.editorContainer, { value: '', theme: 'dracula', lineNumbers: true, lineWrapping: true, autoCloseBrackets: true });
                        codeMirrorEditor.on('change', () => {
                            if(activeFile && files[activeFile]) files[activeFile].content = codeMirrorEditor.getValue();
                            if (!dom.idePreviewPanel.classList.contains('hidden-view')) updatePreview();
                        });
                        dom.loadingOverlay.style.opacity = '0';
                        setTimeout(() => dom.loadingOverlay.style.display = 'none', 300);
                        checkEmptyState();
                    };

                    const checkEmptyState = () => {
                        const hasFiles = Object.keys(files).length > 0;
                        dom.emptyStateContainer.style.display = hasFiles ? 'none' : 'flex';
                        dom.fileTabsContainer.style.display = hasFiles ? 'flex' : 'none';
                        if (codeMirrorEditor) {
                             codeMirrorEditor.getWrapperElement().style.display = hasFiles ? 'block' : 'none';
                             if(!hasFiles) activeFile = null;
                        }
                    };
                    
                    const updatePreview = debounce(() => {
                         if (!files['index.html'] || typeof files['index.html'].content !== 'string') {
                             dom.previewFrame.srcdoc = \`<html><body><h2 style="font-family: sans-serif; text-align: center; margin-top: 2rem; color: #555;">Preview requires an index.html file.</h2></body></html>\`;
                             return;
                         }
                        
                         let htmlContent = files['index.html'].content;
                         const consoleInterceptor = \`const c=window.parent.document.getElementById('console-content');if(c){const createLog=(t,a)=>{const el=document.createElement('div');el.className='console-'+t;el.textContent='> '+Array.from(a).map(arg=>{try{return typeof arg==='object'?JSON.stringify(arg,null,2):String(arg)}catch(e){return 'Unserializable Object'}}).join(' ');c.appendChild(el);c.scrollTop=c.scrollHeight};window.console={log:(...a)=>createLog('log',a),error:(...a)=>createLog('error',a),warn:(...a)=>createLog('warn',a)};window.addEventListener('error',e=>createLog('error',[e.message]))}\`;

                         if (files['style.css'] && typeof files['style.css'].content === 'string') {
                             const styleTag = \`<style>\\n\${files['style.css'].content}\\n</style>\`;
                             htmlContent = htmlContent.replace(/<link[^>]*?href\\s*=\\s*['"](.\\/)?style\\.css['"][^>]*?\\/?>/i, styleTag);
                             if (!htmlContent.includes(styleTag)) htmlContent = htmlContent.replace('</head>', \`\${styleTag}\\n</head>\`);
                         }
                         let scriptContent = consoleInterceptor + (files['script.js']?.content || '');
                         const scriptTag = \`<script>\\n\${scriptContent}\\n<\\/script>\`;
                         htmlContent = htmlContent.replace(/<script[^>]*?src\\s*=\\s*['"](.\\/)?script\\.js['"][^>]*?>\\s*<\\/script>/i, scriptTag);
                         if (!htmlContent.includes(scriptContent)) htmlContent = htmlContent.replace('</body>', \`\${scriptTag}\\n</body>\`);
                         
                         dom.previewFrame.srcdoc = htmlContent;
                    }, 500);

                    const switchMainView = (view) => {
                        document.querySelectorAll('[data-action="switch-view"]').forEach(btn => btn.classList.toggle('active-toggle', btn.dataset.view === view));
                        
                        dom.ideEditorPanel.classList.toggle('hidden-view', view !== 'code');
                        dom.idePreviewPanel.classList.toggle('hidden-view', view !== 'preview');
                        dom.ideStoragePanel.classList.toggle('hidden-view', view !== 'storage');
                        
                        if (view === 'preview') { 
                            dom.consoleContent.innerHTML = ''; 
                            updatePreview();
                        } else if (view === 'code' && codeMirrorEditor) { 
                            setTimeout(() => codeMirrorEditor.refresh(), 1);
                        } else if (view === 'storage') {
                            renderProjectList();
                        }
                    };
                    
                    const createNewFile = (filename, content = '', shouldSwitch = true) => {
                        files[filename] = { content, ...getModeFromFilename(filename) };
                        if(!activeFile) activeFile = filename;
                        if(shouldSwitch) switchTab(filename);
                        else refreshTabs();
                    };
                    
                    const deleteFile = (filenameToDelete) => {
                        if (!files[filenameToDelete]) return;
                        const wasActive = activeFile === filenameToDelete;
                        delete files[filenameToDelete];
                        const remainingFiles = Object.keys(files);
                        if (wasActive) switchTab(remainingFiles.length > 0 ? remainingFiles[0] : null);
                        else refreshTabs();
                    };

                    const refreshTabs = () => {
                        dom.fileTabsContainer.innerHTML = '';
                        Object.keys(files).forEach(filename => {
                            const tab = document.createElement('div');
                            tab.className = \`file-tab \${filename === activeFile ? 'active' : ''}\`;
                            tab.innerHTML = \`<span class="filename-span">\${filename}</span><button class="close-tab-btn" title="Delete \${filename}">&times;</button>\`;
                            dom.fileTabsContainer.appendChild(tab);
                        });
                        checkEmptyState();
                    };
                    
                    const switchTab = (filename) => {
                        if (codeMirrorEditor && activeFile && files[activeFile]) files[activeFile].content = codeMirrorEditor.getValue();
                        activeFile = filename;
                        if (codeMirrorEditor) {
                            const fileContent = filename && files[filename] ? files[filename].content : '';
                            codeMirrorEditor.setValue(fileContent);
                            codeMirrorEditor.clearHistory();
                            if (filename && files[filename]) codeMirrorEditor.setOption('mode', getModeFromFilename(filename).mime);
                            codeMirrorEditor.focus();
                        }
                        refreshTabs();
                    };

                    const getSavedProjects = () => JSON.parse(localStorage.getItem('maGOG_projects')) || {};

                    const renderProjectList = () => {
                        const projects = getSavedProjects();
                        dom.projectList.innerHTML = '';
                        if (Object.keys(projects).length === 0) {
                            dom.projectList.innerHTML = '<li class="text-gray-500 text-center py-4">No saved projects yet.</li>';
                            return;
                        }
                        for (const name in projects) {
                            const li = document.createElement('li');
                            li.className = 'storage-project-item';
                            li.innerHTML = \`
                                <span class="font-semibold">\${name}</span>
                                <div class="flex gap-2">
                                    <button class="storage-btn" data-action="load-project" data-project-name="\${name}">Load</button>
                                    <button class="storage-btn storage-btn-danger" data-action="delete-project" data-project-name="\${name}">Delete</button>
                                </div>
                            \`;
                            dom.projectList.appendChild(li);
                        }
                    };

                    const actions = {
                        'undo': () => codeMirrorEditor?.undo(),
                        'redo': () => codeMirrorEditor?.redo(),
                        'create-project': () => {
                            files = {};
                            createNewFile('index.html', \`<!DOCTYPE html>\\n<html lang="en">\\n<head>\\n  <meta charset="UTF-8">\\n  <title>maGOG Project</title>\\n  <link rel="stylesheet" href="style.css">\\n</head>\\n<body>\\n  <h1>Welcome to your Project!</h1>\\n  <script src="script.js"><\\/script>\\n</body>\\n</html>\`, false);
                            createNewFile('style.css', \`body {\\n  font-family: sans-serif;\\n  background-color: #2d3748;\\n  color: white;\\n  display: grid;\\n  place-content: center;\\n  height: 100vh;\\n  margin: 0;\\n  text-align: center;\\n}\`, false);
                            createNewFile('script.js', \`console.log('Project loaded successfully!');\`, false);
                            switchTab('index.html');
                        },
                        'upload': () => dom.uploadInput.click(),
                        'download': () => {
                             if (!activeFile || !files[activeFile]) return showToast("No active file to download.");
                            const { content, mime } = files[activeFile];
                            const blob = new Blob([content], { type: mime });
                            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = activeFile; a.click(); URL.revokeObjectURL(a.href);
                        },
                        'ai-assistant': () => showToast("AI Assistant coming soon!"),
                        'toggle-console': () => dom.consolePanel.classList.toggle('active'),
                        'clear-console': () => dom.consoleContent.innerHTML = '',
                        'switch-view': (el) => switchMainView(el.dataset.view),
                        'load-project': (el) => {
                            const name = el.dataset.projectName;
                            const projects = getSavedProjects();
                            if (projects[name]) {
                                files = projects[name].files;
                                activeFile = projects[name].activeFile;
                                switchTab(activeFile || Object.keys(files)[0]);
                                switchMainView('code');
                                showToast(\`Project "\${name}" loaded.\`);
                            }
                        },
                        'delete-project': (el) => {
                            const name = el.dataset.projectName;
                             showModal(
                                'Delete Project',
                                \`<p>Are you sure you want to delete the project "<strong>\${name}</strong>"? This cannot be undone.</p>\`,
                                [
                                    { text: 'Cancel', class: 'storage-btn bg-gray-600 hover:bg-gray-500', onClick: closeModal },
                                    { text: 'Delete', class: 'storage-btn storage-btn-danger', onClick: () => {
                                        const projects = getSavedProjects();
                                        delete projects[name];
                                        localStorage.setItem('maGOG_projects', JSON.stringify(projects));
                                        renderProjectList();
                                        showToast(\`Project "\${name}" deleted.\`);
                                        closeModal();
                                    }}
                                ]
                            );
                        },
                    };

                    const setupEventListeners = () => {
                        document.body.addEventListener('click', (e) => {
                            const actionElement = e.target.closest('[data-action]');
                            if (actionElement) actions[actionElement.dataset.action]?.(actionElement);
                            const tabEl = e.target.closest('.filename-span');
                            if (tabEl) switchTab(tabEl.textContent);
                            const closeBtn = e.target.closest('.close-tab-btn');
                            if (closeBtn) deleteFile(closeBtn.previousElementSibling.textContent);
                        });

                        dom.saveProjectBtn.addEventListener('click', () => {
                            const name = dom.projectNameInput.value.trim();
                            if (!name) return showToast("Please enter a project name.");
                            if (Object.keys(files).length === 0) return showToast("Cannot save an empty project.");

                            const projects = getSavedProjects();
                            projects[name] = { files, activeFile };
                            localStorage.setItem('maGOG_projects', JSON.stringify(projects));
                            renderProjectList();
                            showToast(\`Project "\${name}" saved!\`);
                        });

                        dom.uploadInput.addEventListener('change', (e) => {
                            const uploadedFiles = Array.from(e.target.files);
                            if (!uploadedFiles.length) return;
                            files = {};
                            let firstFile = uploadedFiles.find(f => f.name === 'index.html')?.name || uploadedFiles[0]?.name;
                            let loadedCount = 0;
                            uploadedFiles.forEach((file) => {
                                const reader = new FileReader();
                                reader.onload = (re) => {
                                    createNewFile(file.name, re.target.result, false);
                                    loadedCount++;
                                    if (loadedCount === uploadedFiles.length) switchTab(firstFile);
                                };
                                reader.readAsText(file); 
                            });
                            e.target.value = '';
                        });
                    };
                    
                    window.addEventListener('load', () => {
                        initCodeMirror();
                        setupEventListeners();
                        switchMainView('code');
                    });
                <\/script>
            </body>
            </html>
        `;

        const codeStudioToolHTML = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AI-Powered Code Studio</title>
            
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
              <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"><\/script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js"><\/script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"><\/script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js"><\/script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/htmlmixed/htmlmixed.min.js"><\/script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/display/placeholder.js"><\/script>
            
              <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"><\/script>
              
              <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"><\/script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"><\/script>
            
              <style>
                :root {
                  --primary-color: #007bff; --primary-hover: #0056b3;
                  --secondary-color: #6c757d; --secondary-hover: #5a6268;
                  --danger-color: #dc3545; --danger-hover: #c82333;
                  --gemini-purple: #8A2BE2; --gemini-hover: #7B1FA2;
                  --dark-bg: #1a1a1a; --card-bg: rgba(38, 38, 38, 0.8);
                  --border-color: rgba(255, 255, 255, 0.1); --text-color: #e0e0e0;
                  --subtle-text-color: #b0b0b0;
                }
                body { font-family: 'Inter', Arial, sans-serif; background: var(--dark-bg); color: var(--text-color); margin: 0; padding: 20px; }
                .card { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
                .head { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px; }
                .head .btn-group { display: flex; gap: 10px; }
                h2 { margin: 0; font-weight: 600; }
                h3 { margin-top: 0; color: var(--subtle-text-color); }
                .row { display: flex; gap: 10px; margin: 10px 0; }
                
                .btn {
                  background: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer;
                  transition: background-color 0.3s, transform 0.2s, opacity 0.2s; font-weight: 500; text-decoration: none; display: inline-flex;
                  align-items: center; justify-content: center; gap: 8px;
                }
                .btn:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-1px); }
                .btn:disabled { background: #495057; cursor: not-allowed; transform: none; opacity: 0.6; }
                .btn.secondary { background: var(--secondary-color); } .btn.secondary:hover { background: var(--secondary-hover); }
                .btn.danger { background: var(--danger-color); } .btn.danger:hover { background: var(--danger-hover); }
                .btn.gemini { background: var(--gemini-purple); } .btn.gemini:hover:not(:disabled) { background: var(--gemini-hover); }
            
                .mode-switcher { display: flex; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 5px; }
                .mode-switcher .btn { flex: 1; background: transparent; color: var(--subtle-text-color); }
                .mode-switcher .btn.active { background: var(--primary-color); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
                .mode-switcher .btn:hover:not(.active) { background: rgba(255,255,255,0.1); transform: none; }
                
                .CodeMirror { border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; height: 300px; font-family: 'Courier New', monospace; }
                .CodeMirror-focused { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); }
                .CodeMirror-placeholder { color: #888 !important; }
            
                .outputs .codebox { margin: 20px 0; }
                .bar { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 8px 12px; border-radius: 8px 8px 0 0; font-weight: bold; }
                .bar-controls { display: flex; align-items: center; gap: 10px; }
                .code-count { font-size: 0.8em; font-weight: 500; color: var(--subtle-text-color); background-color: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 4px; }
                .bar-btn { background: none; border: none; cursor: pointer; color: var(--subtle-text-color); padding: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: color 0.2s, background-color 0.2s; }
                .bar-btn:hover { color: white; background-color: rgba(255,255,255,0.1); }
                .bar-btn svg { width: 16px; height: 16px; pointer-events: none; }
                .ai-btn { color: var(--gemini-purple); } .ai-btn:hover { color: #a55cff; }
                pre { background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 0 0 8px 8px; margin: 0; white-space: pre-wrap; word-wrap: break-word; overflow-x: auto; max-height: 400px; border: 1px solid rgba(255, 255, 255, 0.2); border-top: none; }
            
                #js-refactor-instructions { width: 100%; box-sizing: border-box; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; color: var(--text-color); margin-bottom: 10px; height: 100px; font-family: 'Inter', sans-serif; font-size: 14px; }
                .refactor-output { border: 1px solid var(--border-color); border-radius: 8px; padding: 1em; background-color: rgba(0,0,0,0.2); min-height: 200px; max-height: 60vh; overflow-y: auto; }
                #ai-help-refactor-btn svg, #download-refactor-btn svg { width: 16px; height: 16px; }
            
                .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
                .modal-content { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
                .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
                .modal-header h3 { margin: 0; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--gemini-purple); }
                .close-modal { background: none; border: none; color: var(--subtle-text-color); font-size: 24px; cursor: pointer; line-height: 1; padding: 0 5px; transition: color 0.2s; }
                .close-modal:hover { color: white; }
                .modal-body { padding: 20px; overflow-y: auto; }
                .modal-body h1, .modal-body h2, .modal-body h3 { margin-top: 1em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em;}
              </style>
            </head>
            <body>
            
              <div class="card">
                <div class="mode-switcher">
                  <button class="btn active" id="mode-split">Split</button>
                  <button class="btn" id="mode-combine">Combine</button>
                  <button class="btn" id="mode-js-refactor">JS Refactor</button>
                </div>
              </div>
            
              <div id="split-mode-container">
                <div class="card"><div class="head"><h2>Input Code to Split</h2><button class="btn danger" id="clearInput">Clear All</button></div><textarea id="main-input"></textarea></div>
                <div class="card">
                  <div class="head"><h2>Outputs</h2></div>
                  <div class="body outputs">
                    <div class="codebox"><div class="bar"><span>index.html</span><div class="bar-controls"><span class="code-count" id="html-count">(0,0)</span><button class="bar-btn copy-btn" data-target="outIndex" title="Copy"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button><button class="bar-btn ai-btn" data-target="outIndex" data-lang="html" title="AI Help"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6.5 17.5l-1.5 1.5M18.5 17.5l1.5 1.5M12 8v4l3 3M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button><button class="bar-btn clear-btn-single" data-target="outIndex" data-dl="dlIndex" title="Clear"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div></div><pre><code id="outIndex"></code></pre></div>
                    <div class="codebox"><div class="bar"><span>style.css</span><div class="bar-controls"><span class="code-count" id="css-count">(0,0)</span><button class="bar-btn copy-btn" data-target="outCSS" title="Copy"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button><button class="bar-btn ai-btn" data-target="outCSS" data-lang="css" title="AI Help"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6.5 17.5l-1.5 1.5M18.5 17.5l1.5 1.5M12 8v4l3 3M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button><button class="bar-btn clear-btn-single" data-target="outCSS" data-dl="dlCSS" title="Clear"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div></div><pre><code id="outCSS"></code></pre></div>
                    <div class="codebox"><div class="bar"><span>script.js</span><div class="bar-controls"><span class="code-count" id="js-count">(0,0)</span><button class="bar-btn copy-btn" data-target="outJS" title="Copy"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button><button class="bar-btn ai-btn" data-target="outJS" data-lang="javascript" title="AI Help"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6.5 17.5l-1.5 1.5M18.5 17.5l1.5 1.5M12 8v4l3 3M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button><button class="bar-btn clear-btn-single" data-target="outJS" data-dl="dlJS" title="Clear"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div></div><pre><code id="outJS"></code></pre></div>
                    <div class="codebox"><div class="bar"><span>project.json</span><div class="bar-controls"><span class="code-count" id="json-count">(0,0)</span><button class="bar-btn copy-btn" data-target="outJSON" title="Copy"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button><button class="bar-btn ai-btn" data-target="outJSON" data-lang="json" title="AI Help"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6.5 17.5l-1.5 1.5M18.5 17.5l1.5 1.5M12 8v4l3 3M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button><button class="bar-btn clear-btn-single" data-target="outJSON" data-dl="dlJSON" title="Clear"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div></div><pre><code id="outJSON"></code></pre></div>
                    <div class="row" style="flex-wrap: wrap; gap: 10px;"><a class="btn" id="dlIndex">Download .html</a><a class="btn" id="dlCSS">Download .css</a><a class="btn" id="dlJS">Download .js</a><a class="btn" id="dlJSON">Download .json</a><button class="btn secondary" id="downloadAllSplit">Download All (.zip)</button></div>
                  </div>
                </div>
              </div>
            
              <div id="combine-mode-container" style="display: none;"><div class="card"><div class="head"><h2>Inputs to Combine</h2></div><div class="codebox"><div class="bar"><span>HTML</span></div><textarea id="combine-html-input"></textarea></div><div class="codebox"><div class="bar"><span>CSS</span></div><textarea id="combine-css-input"></textarea></div><div class="codebox"><div class="bar"><span>JavaScript</span></div><textarea id="combine-js-input"></textarea></div><div class="row"><button class="btn" id="combineBtn">Combine Files</button></div></div><div class="card"><div class="head"><h2>Combined Output</h2></div><div class="body outputs"><div class="codebox"><div class="bar"><span>combined.html</span><div class="bar-controls"><span class="code-count" id="combined-count">(0,0)</span><button class="bar-btn copy-btn" data-target="outCombined" title="Copy"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button></div></div><pre><code id="outCombined"></code></pre></div><div class="row"><a class="btn" id="dlCombined">Download combined.html</a></div></div></div></div>
              
              <div id="js-refactor-mode-container" style="display: none;">
                <div class="card"><div class="head"><h2>JavaScript AI Refactor</h2></div><h3>1. Input Your Monolithic JavaScript</h3><textarea id="js-refactor-input"></textarea><h3 style="margin-top:20px;">2. Describe How to Refactor It</h3><textarea id="js-refactor-instructions" placeholder="e.g., 'Refactor this game code into separate manager classes for State, Input, and Rendering.' or 'Convert this to a modular pattern using ES6 modules.'"></textarea><div class="row"><button class="btn gemini" id="js-refactor-btn">✨ Refactor with AI</button></div></div>
                <div class="card">
                    <div class="head"><h2>AI-Generated Structure</h2><div class="btn-group"><button class="btn secondary" id="download-refactor-btn" style="display: none;"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> Download (.zip)</button><button class="btn gemini" id="ai-help-refactor-btn" style="display: none;"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6.5 17.5l-1.5 1.5M18.5 17.5l1.5 1.5M12 8v4l3 3M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Ask Follow-up</button></div></div>
                    <div class="refactor-output" id="js-refactor-output">Your refactored code structure will appear here...</div>
                </div>
              </div>
            
              <div id="ai-modal" class="modal-overlay" style="display: none;"><div class="modal-content"><div class="modal-header"><h3>✨ AI Analysis</h3><button class="close-modal">&times;</button></div><div class="modal-body" id="ai-modal-output"></div></div></div>
            
              <script type="module">
                // Firebase SDK for backend capabilities
                import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
                import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
                import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
            
                const state = { 
                    editors: {}, 
                    currentMode: 'split', 
                    refactorHistory: [], 
                    apiKey: 'AIzaSyCScYif-cFgt8bn3p1gJuGUT6ICUQmo5Bw'
                };
                const qs = (sel, ctx = document) => ctx.querySelector(sel);
                
                const libraries = { 'React': 'https://unpkg.com/react@18/umd/react.development.js', 'ReactDOM': 'https://unpkg.com/react-dom@18/umd/react-dom.development.js', 'Vue': 'https://unpkg.com/vue@3/dist/vue.global.js', 'jQuery': 'https://code.jquery.com/jquery-3.7.1.min.js', 'three.js': 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js', 'd3': 'https://d3js.org/d3.v7.min.js' };
            
                const detectLibraries = (code) => {
                    const detected = [];
                    if (code.includes('React.createElement') || code.includes('jsx(')) detected.push('React', 'ReactDOM');
                    if (code.includes('new Vue') || code.includes('createApp')) detected.push('Vue');
                    if (code.match(/\\$\\s*\\(/)) detected.push('jQuery');
                    if (code.includes('new THREE.')) detected.push('three.js');
                    if (code.includes('d3.select')) detected.push('d3');
                    return [...new Set(detected)];
                };
            
                const setDownload = (a, filename, content, mimeType) => {
                  if (!a) return;
                  if (!content) { a.removeAttribute('href'); a.style.opacity = '0.5'; a.style.cursor = 'not-allowed'; } 
                  else { const blob = new Blob([content], { type: mimeType }); a.href = URL.createObjectURL(blob); a.download = filename; a.style.opacity = '1'; a.style.cursor = 'pointer'; }
                };
            
                const showToast = (message, type = 'info') => {
                  const toast = document.createElement('div');
                  toast.textContent = message;
                  const bgColor = type === 'error' ? 'var(--danger-color)' : type === 'success' ? '#28a745' : 'rgba(0,0,0,0.8)';
                  toast.style.cssText = \`position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: \${bgColor}; color: white; padding: 12px 24px; border-radius: 8px; z-index: 1001; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); opacity: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.2);\`;
                  document.body.appendChild(toast);
                  setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translateX(-50%)'; }, 10);
                  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3000);
                };
            
                const updateOutput = (preId, countId, content) => {
                  const finalContent = content || '';
                  const lineCount = finalContent ? finalContent.split('\\n').length : 0;
                  const charCount = finalContent.length;
                  qs(\`#\${preId}\`).textContent = finalContent;
                  if (qs(\`#\${countId}\`)) qs(\`#\${countId}\`).textContent = \`(\${lineCount}, \${charCount})\`;
                };
            
                const prettyPrintHTML = (html) => {
                  let indent = ''; const tab = '  '; let result = '';
                  let lines = html.replace(/>\s*</g, '>\\n<').split('\\n');
                  lines.forEach(line => {
                    let trimmed = line.trim(); if (!trimmed) return;
                    if (trimmed.match(/^<\\//)) indent = indent.substring(tab.length);
                    result += indent + trimmed + '\\n';
                    if (trimmed.match(/^<[^\\/]/) && !trimmed.match(/\\/>$/) && !['<meta', '<link', '<br', '<hr', '<img', '<input'].some(t => trimmed.startsWith(t))) indent += tab;
                  });
                  return result.trim();
                };
            
                const switchMode = (mode) => {
                  state.currentMode = mode;
                  qs('#split-mode-container').style.display = mode === 'split' ? 'block' : 'none';
                  qs('#combine-mode-container').style.display = mode === 'combine' ? 'block' : 'none';
                  qs('#js-refactor-mode-container').style.display = mode === 'js-refactor' ? 'block' : 'none';
                  document.querySelectorAll('.mode-switcher .btn').forEach(b => b.classList.remove('active'));
                  qs(\`#mode-\${mode}\`).classList.add('active');
                };
            
                const handleSplit = async () => {
                  const inputCode = state.editors.main.getValue().trim();
                  if (!inputCode) { showToast('Paste code to split.', 'error'); return; }
                  try {
                    const parser = new DOMParser(); const doc = parser.parseFromString(inputCode, 'text/html');
                    if (doc.querySelector('parsererror')) throw new Error("Invalid HTML.");
                    
                    let cssOut = '', jsOut = '';
                    doc.querySelectorAll('style').forEach(el => { cssOut += el.textContent + '\\n\\n'; el.remove(); });
                    doc.querySelectorAll('link[rel="stylesheet"]').forEach(el => el.remove());
                    doc.querySelectorAll('script').forEach(el => { if (!el.src) jsOut += el.textContent + '\\n\\n'; el.remove(); });
            
                    const detected = detectLibraries(inputCode);
                    if (cssOut.trim()) { const link = doc.createElement('link'); link.rel = 'stylesheet'; link.href = 'style.css'; doc.head.appendChild(link); }
                    detected.forEach(libName => { const script = doc.createElement('script'); script.src = libraries[libName]; doc.head.appendChild(script); });
                    if (jsOut.trim()) { const script = doc.createElement('script'); script.src = 'script.js'; script.defer = true; doc.body.appendChild(script); }
                    
                    let htmlOut = prettyPrintHTML(\`<!DOCTYPE html>\\n\${doc.documentElement.outerHTML}\`);
                    const finalCss = cssOut.trim(), finalJs = jsOut.trim();
                    const jsonOut = JSON.stringify({ htmlFile: 'index.html', cssFile: 'style.css', jsFile: 'script.js', libraries: detected }, null, 2);
            
                    updateOutput('outIndex', 'html-count', htmlOut); updateOutput('outCSS', 'css-count', finalCss); updateOutput('outJS', 'js-count', finalJs); updateOutput('outJSON', 'json-count', jsonOut);
                    setDownload(qs('#dlIndex'), 'index.html', htmlOut, 'text/html'); setDownload(qs('#dlCSS'), 'style.css', finalCss, 'text/css'); setDownload(qs('#dlJS'), 'script.js', finalJs, 'application/javascript'); setDownload(qs('#dlJSON'), 'project.json', jsonOut, 'application/json');
                    
                  } catch (e) { showToast(\`Error: \${e.message}\`, 'error'); }
                };
            
                const handleCombine = () => {
                    const htmlIn = state.editors.combineHtml.getValue().trim(); const cssIn = state.editors.combineCss.getValue().trim(); const jsIn = state.editors.combineJs.getValue().trim();
                    if (!htmlIn) { showToast('HTML is required.', 'error'); return; }
                    try {
                        const parser = new DOMParser(); let doc = htmlIn.toLowerCase().includes('<html') ? parser.parseFromString(htmlIn, 'text/html') : parser.parseFromString(\`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Combined</title></head><body>\${htmlIn}</body></html>\`, 'text/html');
                        if (!doc || doc.querySelector('parsererror')) throw new Error("Invalid HTML.");
                        if (cssIn) { const style = doc.createElement('style'); style.textContent = \`\\n\${cssIn}\\n\`; doc.head.appendChild(style); }
                        if (jsIn) { const script = doc.createElement('script'); script.textContent = \`\\n\${jsIn}\\n\`; doc.body.appendChild(script); }
                        let finalHtml = prettyPrintHTML(\`<!DOCTYPE html>\\n\${doc.documentElement.outerHTML}\`);
                        updateOutput('outCombined', 'combined-count', finalHtml); setDownload(qs('#dlCombined'), 'combined.html', finalHtml, 'text/html');
                    } catch (e) { showToast(\`Error: \${e.message}\`, 'error'); }
                };
                
                const callGemini = async (prompt) => {
                    if (!state.apiKey) {
                        showToast("API Key is not configured.", "error"); 
                        return null;
                    }
                    try {
                        const model = 'gemini-1.5-flash-latest';
                        const apiUrl = \`https://generativelanguage.googleapis.com/v1beta/models/\${model}:generateContent?key=\${state.apiKey}\`;
            
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(\`API Error: \${error.error.message}\`);
                        }
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!text) throw new Error("No content in API response.");
                        return text;
                    } catch (error) { showToast(error.message, 'error'); return null; }
                };
                
                const handleJsRefactor = async () => {
                    const btn = qs('#js-refactor-btn');
                    const code = state.editors.jsRefactorInput.getValue().trim();
                    const instructions = qs('#js-refactor-instructions').value.trim();
                    if (!code || !instructions) { showToast('Please provide both the JS code and refactoring instructions.', 'error'); return; }
            
                    qs('#js-refactor-output').innerHTML = '<em>Preparing to call AI...</em>';
                    btn.disabled = true; btn.textContent = 'Thinking...';
                    state.refactorHistory = [];
            
                    const prompt = \`Act as a senior software architect. Refactor the following JavaScript code based on the user's request. Explain your reasoning, then provide the refactored code inside markdown code blocks. Use comments like "// filename: component.js" above each code block to suggest a filename.\\n\\n**User Request:** "\${instructions}"\\n\\n**Original Code:**\\n\\\`\\\`\\\`javascript\\n\${code}\\n\\\`\\\`\\\`\`;
                    
                    const result = await callGemini(prompt);
                    btn.disabled = false; btn.textContent = '✨ Refactor with AI';
                    
                    if (result) {
                        state.refactorHistory.push({ role: 'user', parts: [{ text: prompt }] });
                        state.refactorHistory.push({ role: 'model', parts: [{ text: result }] });
                        qs('#js-refactor-output').innerHTML = marked.parse(result);
                        qs('#ai-help-refactor-btn').style.display = 'inline-flex';
                        qs('#download-refactor-btn').style.display = 'inline-flex';
                    } else {
                        qs('#js-refactor-output').textContent = 'The AI refactor failed. Please check your API key or the console for errors.';
                        qs('#ai-help-refactor-btn').style.display = 'none';
                        qs('#download-refactor-btn').style.display = 'none';
                    }
                };
                
                const handleCopy = (e) => {
                    const content = qs(\`#\${e.currentTarget.dataset.target}\`).textContent;
                    if (content) navigator.clipboard.writeText(content).then(() => showToast('Copied!', 'success'), () => showToast('Copy failed.', 'error'));
                    else showToast('Nothing to copy.', 'error');
                };
                
                const handleClearSingle = (e) => {
                    const targetId = e.currentTarget.dataset.target;
                    const dlId = e.currentTarget.dataset.dl;
                    const countId = targetId.replace('out', '').toLowerCase() + '-count';
                    updateOutput(targetId, countId, '');
                    setDownload(qs(\`#\${dlId}\`), null, null, null);
                };
            
                const handleSplitAiHelp = async (e) => {
                    const targetId = e.currentTarget.dataset.target;
                    const lang = e.currentTarget.dataset.lang;
                    const content = qs(\`#\${targetId}\`).textContent;
                    if (!content) { showToast('Nothing to analyze.', 'error'); return; }
                    const prompt = \`Please provide a brief analysis and improvement suggestions for the following code snippet (\\\`\${lang}\\\`). Focus on best practices, potential issues, and readability.\\n\\n\\\`\\\`\\\`\${lang}\\n\${content}\\n\\\`\\\`\\\`\`;
                    showAiModal(prompt);
                };
                
                const handleRefactorAiHelp = async () => {
                    const followUp = prompt("What would you like to ask about the refactored code?");
                    if (!followUp || !followUp.trim()) return;
                    
                    const lastResponse = state.refactorHistory[state.refactorHistory.length - 1]?.parts[0]?.text || "No previous response found.";
                    const promptText = \`Based on the previous refactoring and your response, the user has a follow-up question.\\n\\n**Your Previous Response:**\\n\${lastResponse}\\n\\n**User's Follow-up Question:** "\${followUp}"\\n\\nPlease provide a concise answer.\`;
                    
                    state.refactorHistory.push({ role: 'user', parts: [{ text: promptText }] });
                    const result = await showAiModal(promptText, true);
                    if (result) {
                        state.refactorHistory.push({ role: 'model', parts: [{ text: result }] });
                        const outputEl = qs('#js-refactor-output');
                        outputEl.innerHTML += \`<hr><h3>Follow-up: \${followUp}</h3>\` + marked.parse(result);
                        outputEl.scrollTop = outputEl.scrollHeight;
                    }
                };
            
                const handleDownloadRefactor = async () => {
                    const outputEl = qs('#js-refactor-output');
                    const codeBlocks = outputEl.querySelectorAll('pre'); // Target <pre> elements directly
            
                    if (codeBlocks.length === 0) {
                        showToast('No refactored code blocks found to download.', 'error');
                        return;
                    }
            
                    const zip = new JSZip();
                    let fileCount = 0;
            
                    codeBlocks.forEach((preElement, index) => {
                        const codeContent = preElement.querySelector('code')?.textContent || '';
                        if (!codeContent) return; // Skip if there's no code in the block
            
                        let filename = \`refactored-file-\${index + 1}.js\`; // Default filename
                        const potentialFilenameElement = preElement.previousElementSibling;
            
                        // The AI is prompted to put a comment like "// filename: ..." just before the code block.
                        // Marked.js usually wraps this comment in its own <p> tag.
                        if (potentialFilenameElement && potentialFilenameElement.textContent.includes('// filename:')) {
                            const match = potentialFilenameElement.textContent.match(/\\/\\/\\s*filename:\\s*(\\S+\\.js|\\S+\\.html|\\S+\\.css)/);
                            if (match && match[1]) {
                                filename = match[1];
                            }
                        }
                        
                        zip.file(filename, codeContent);
                        fileCount++;
                    });
            
                    if (fileCount > 0) {
                         try {
                            const content = await zip.generateAsync({ type: "blob" });
                            saveAs(content, "refactored-code.zip");
                            showToast(\`Zipped and downloaded \${fileCount} files.\`, 'success');
                        } catch (e) { showToast(\`Error creating zip file: \${e.message}\`, 'error'); }
                    } else {
                        showToast('Failed to extract any code to download.', 'error');
                    }
                };
                
                const handleDownloadAllSplit = async () => {
                    const zip = new JSZip();
                    let fileCount = 0;
                    const filesToZip = [
                        { name: 'index.html', content: qs('#outIndex').textContent },
                        { name: 'style.css', content: qs('#outCSS').textContent },
                        { name: 'script.js', content: qs('#outJS').textContent },
                        { name: 'project.json', content: qs('#outJSON').textContent },
                    ];
            
                    filesToZip.forEach(file => {
                        if (file.content) {
                            zip.file(file.name, file.content);
                            fileCount++;
                        }
                    });
            
                    if (fileCount === 0) { showToast('No files to download.', 'error'); return; }
                    
                    try {
                        const content = await zip.generateAsync({ type: "blob" });
                        saveAs(content, "code-studio-split.zip");
                    } catch (e) { showToast(\`Error creating zip file: \${e.message}\`, 'error'); }
                };
            
                const showAiModal = async (prompt, returnResult = false) => {
                    const modal = qs('#ai-modal');
                    const outputEl = qs('#ai-modal-output');
                    modal.style.display = 'flex';
                    outputEl.innerHTML = '<em>Thinking...</em>';
                    const result = await callGemini(prompt);
                    if (result) {
                        outputEl.innerHTML = marked.parse(result);
                        if (returnResult) return result;
                    } else {
                        outputEl.innerHTML = 'Sorry, the request failed.';
                        if (returnResult) return null;
                    }
                };
            
                const hideAiModal = () => { qs('#ai-modal').style.display = 'none'; };
            
                const setupEventListeners = () => {
                  qs('#mode-split').addEventListener('click', () => switchMode('split'));
                  qs('#mode-combine').addEventListener('click', () => switchMode('combine'));
                  qs('#mode-js-refactor').addEventListener('click', () => switchMode('js-refactor'));
                  
                  state.editors.main.on('paste', () => { setTimeout(handleSplit, 200); });
                  qs('#clearInput').addEventListener('click', () => {
                      state.editors.main.setValue('');
                      ['html', 'css', 'js', 'json'].forEach(type => {
                          const cap = type.charAt(0).toUpperCase() + type.slice(1);
                          updateOutput(\`out\${cap}\`, \`\${type}-count\`, '');
                          setDownload(qs(\`#dl\${cap}\`), null, null, null);
                      });
                  });
                  qs('#combineBtn').addEventListener('click', handleCombine);
                  qs('#js-refactor-btn').addEventListener('click', handleJsRefactor);
                  qs('#ai-help-refactor-btn').addEventListener('click', handleRefactorAiHelp);
                  qs('#download-refactor-btn').addEventListener('click', handleDownloadRefactor);
                  qs('#downloadAllSplit').addEventListener('click', handleDownloadAllSplit);
            
                  document.querySelectorAll('.copy-btn').forEach(btn => btn.addEventListener('click', handleCopy));
                  document.querySelectorAll('.clear-btn-single').forEach(btn => btn.addEventListener('click', handleClearSingle));
                  document.querySelectorAll('.ai-btn').forEach(btn => btn.addEventListener('click', handleSplitAiHelp));
                  
                  qs('#ai-modal .close-modal').addEventListener('click', hideAiModal);
                  qs('#ai-modal').addEventListener('click', (e) => { if(e.target === qs('#ai-modal')) hideAiModal(); });
                };
            
                window.addEventListener('load', () => {
                  const firebaseConfig = {
                    
                    authDomain: "ma-gog.firebaseapp.com",
                    projectId: "ma-gog",
                    storageBucket: "ma-gog.appspot.com", 
                    messagingSenderId: "952701775950",
                    appId: "1:952701775950:web:5bae36c33f0cfa9a07d497"
                  };
            
                  try {
                    const app = initializeApp(firebaseConfig);
                    const db = getFirestore(app);
                    const auth = getAuth(app);
                    console.log("Firebase Initialized Successfully");
                    showToast('Firebase Connected!', 'success');
                  } catch (e) {
                    console.error("Firebase Initialization Error:", e);
                    showToast(\`Firebase Error: \${e.message}\`, 'error');
                  }
            
                  state.editors.main = CodeMirror.fromTextArea(qs('#main-input'), { mode: 'htmlmixed', theme: 'dracula', lineNumbers: true, lineWrapping: true, placeholder: 'Paste combined code to split...' });
                  state.editors.combineHtml = CodeMirror.fromTextArea(qs('#combine-html-input'), { mode: 'htmlmixed', theme: 'dracula', lineNumbers: true, placeholder: 'HTML' });
                  state.editors.combineCss = CodeMirror.fromTextArea(qs('#combine-css-input'), { mode: 'css', theme: 'dracula', lineNumbers: true, placeholder: 'CSS' });
                  state.editors.combineJs = CodeMirror.fromTextArea(qs('#combine-js-input'), { mode: 'javascript', theme: 'dracula', lineNumbers: true, placeholder: 'JS' });
                  state.editors.jsRefactorInput = CodeMirror.fromTextArea(qs('#js-refactor-input'), { mode: 'javascript', theme: 'dracula', lineNumbers: true, placeholder: 'Paste monolithic JS here...' });
            
                  setupEventListeners();
                  switchMode('split');
                  ['Index', 'CSS', 'JS', 'JSON'].forEach(id => setDownload(qs(\`#dl\${id}\`), null, null, null));
                });
              <\/script>
            </body>
            </html>
        `;

        document.addEventListener('DOMContentLoaded', () => {
            // Your web app's Firebase configuration
            const firebaseConfig = {
                
                authDomain: "ma-gog.firebaseapp.com",
                projectId: "ma-gog",
                storageBucket: "ma-gog.firebasestorage.app",
                messagingSenderId: "952701776950",
                appId: "1:952701776950:web:5bae36c33f0cfa9a07d497"
            };

            const DOM = {
                views: { 
                    auth: document.getElementById('authView'), 
                    home: document.getElementById('homeView'),
                    dashboard: document.getElementById('dashboardView'), 
                    editor: document.getElementById('editorView'),
                    canvas: document.getElementById('canvasView'),
                    tools: document.getElementById('toolsView'),
                    focus: document.getElementById('focusModeView')
                },
                loginForm: document.getElementById('loginForm'),
                registerForm: document.getElementById('registerForm'),
                loginSwitch: document.getElementById('loginSwitch'),
                registerSwitch: document.getElementById('registerSwitch'),
                authMessageBox: document.getElementById('authMessageBox'),
                devLoginBtn: document.getElementById('devLoginBtn'),
                logoutBtn: document.getElementById('logoutBtn'),
                fileUploader: document.getElementById('fileUploader'),
                storageUploader: document.getElementById('storageUploader'),
                assetUploader: document.getElementById('assetUploader'),
                hub: {
                    editorBtn: document.getElementById('hubEditorBtn'),
                    storageBtn: document.getElementById('hubStorageBtn'),
                    canvasIframeBtn: document.getElementById('hubCanvasIframeBtn'),
                    toolsBtn: document.getElementById('hubToolsBtn'),
                },
                dashboardTitle: document.getElementById('dashboardTitle'),
                dashboardBackBtn: document.getElementById('dashboardBackBtn'),
                itemList: document.getElementById('itemList'),
                newItemBtn: document.getElementById('newItemBtn'),
                uploadStorageBtn: document.getElementById('uploadStorageBtn'),
                backToDashboardBtn: document.getElementById('backToDashboardBtn'),
                fileTree: document.getElementById('fileTree'),
                saveButton: document.getElementById('saveButton'),
                previewFrame: document.getElementById('previewFrame'),
                bottomNav: document.querySelector('#editorView nav'),
                modalContainer: document.getElementById('modalContainer'),
                contextMenu: document.getElementById('contextMenu'),
                headerTitle: document.querySelector('#editorView #headerTitle'),
                headerActions: document.getElementById('headerActions'),
                manageLibrariesBtn: document.getElementById('manageLibrariesBtn'),
                runButton: document.querySelector('#editorView #runButton'),
                uploadFileBtn: document.getElementById('uploadFileBtn'),
                newFileBtn: document.getElementById('newFileBtn'),
                newFolderBtn: document.getElementById('newFolderBtn'),
                canvas: {
                    backBtn: document.getElementById('canvasBackBtn'),
                    urlInput: document.getElementById('canvasUrlInput'),
                    loadBtn: document.getElementById('loadCanvasUrlBtn'),
                    iframe: document.getElementById('canvasIframe')
                },
                toolsIframe: document.getElementById('toolsIframe'),
                toolsBackBtn: document.getElementById('toolsBackBtn'),
                editorPanels: {
                    fileExplorerPanel: document.getElementById('fileExplorerPanel'),
                    editorPanel: document.getElementById('editorPanel'),
                    previewPanel: document.getElementById('previewPanel'),
                    assetsPanel: document.getElementById('assetsPanel'),
                    aiPanel: document.getElementById('aiPanel'),
                    searchPanel: document.getElementById('searchPanel'),
                    snippetsPanel: document.getElementById('snippetsPanel'),
                    gitPanel: document.getElementById('gitPanel'),
                    tabBar: document.getElementById('tabBar'),
                    editorWrapper: document.getElementById('editorWrapper'),
                    editorPlaceholder: document.getElementById('editorPlaceholder'),
                },
                assets: {
                    uploadBtn: document.getElementById('uploadAssetBtn'),
                    newFolderBtn: document.getElementById('newAssetFolderBtn'),
                    list: document.getElementById('assetList'),
                },
                ai: {
                    chatContainer: document.getElementById('aiChatContainer'),
                    input: document.getElementById('aiInput'),
                    sendBtn: document.getElementById('aiSendBtn'),
                    actionBtns: document.querySelectorAll('.ai-action-btn'),
                },
                search: {
                    input: document.getElementById('searchInput'),
                    btn: document.getElementById('searchBtn'),
                    results: document.getElementById('searchResults'),
                },
                snippets: {
                    newBtn: document.getElementById('newSnippetBtn'),
                    list: document.getElementById('snippetList'),
                },
                git: {
                    connectView: document.getElementById('gitConnectView'),
                    mainView: document.getElementById('gitMainView'),
                    patInput: document.getElementById('githubPat'),
                    connectBtn: document.getElementById('connectGitBtn'),
                    disconnectBtn: document.getElementById('disconnectGitBtn'),
                    avatar: document.getElementById('githubAvatar'),
                    username: document.getElementById('githubUsername'),
                    repoSelect: document.getElementById('repoSelect'),
                    changesList: document.getElementById('gitChangesList'),
                    stagedList: document.getElementById('gitStagedList'),
                    commitMessage: document.getElementById('commitMessage'),
                    commitBtn: document.getElementById('commitBtn'),
                    pushBtn: document.getElementById('pushBtn'),
                    pullBtn: document.getElementById('pullBtn'),
                    commitHistory: document.getElementById('commitHistory'),
                },
                focus: {
                    enterBtn: document.getElementById('focusModeBtn'),
                    exitBtn: document.getElementById('exitFocusBtn'),
                    editorWrapper: document.getElementById('focusEditorWrapper'),
                }
            };
           const JS_LIBRARIES = {
                'jQuery': 'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js',
                'D3.js': 'https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js',
                'Chart.js': 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js',
                'Three.js': 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
                'p5.js': 'https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js',
                'Phaser': 'https://cdnjs.cloudflare.com/ajax/libs/phaser/3.80.1/phaser.min.js',
                'GSAP': 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js',
                'Anime.js': 'https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js'
            };

            const TEXT_EDITABLE_EXTENSIONS = ['html', 'css', 'js', 'jsx', 'py', 'java', 'c', 'cpp', 'cs', 'php', 'rb', 'go', 'sql', 'json', 'txt', 'md'];

            let app, auth, db, editor, focusEditor;
            let userId, currentProjectId, activeTabId = null;
            let openTabs = [];
            let fileStructureUnsubscribe, projectsUnsubscribe, assetsUnsubscribe, snippetsUnsubscribe;
            let fileStructure = [];
            let gitChangedFiles = [], gitStagedFiles = [];
            let projectsListener = null;
            let lastTapTime = 0, lastTapX = 0, lastTapY = 0;
            let currentDashboard = 'projects';


            function showView(viewName) {
                Object.values(DOM.views).forEach(view => view.classList.remove('active'));
                DOM.views[viewName].classList.add('active');
            }

            function main() {
                try {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    onAuthStateChanged(auth, user => {
                        if (user) {
                            userId = user.uid;
                            showView('home');
                            if (projectsListener) projectsListener();
                            if (fileStructureUnsubscribe) fileStructureUnsubscribe();
                            if (assetsUnsubscribe) assetsUnsubscribe();
                            if (snippetsUnsubscribe) snippetsUnsubscribe();
                            listenForSnippets();
                            checkGitConnection();
                        } else {
                            userId = null;
                            showView('auth');
                            setupAuthForms();
                        }
                    });
                    
                    DOM.hub.editorBtn.onclick = () => loadUserProjects();
                    DOM.hub.storageBtn.onclick = () => loadUserStorage();
                    DOM.hub.canvasIframeBtn.onclick = () => {
                        DOM.canvas.iframe.srcdoc = maGOGSuiteHTML;
                        showView('canvas');
                    };
                    DOM.hub.toolsBtn.onclick = () => {
                        DOM.toolsIframe.srcdoc = codeStudioToolHTML;
                        showView('tools');
                    };
                    
                    DOM.canvas.backBtn.onclick = () => showView('home');
                    DOM.toolsBackBtn.onclick = () => showView('home');
                    DOM.canvas.loadBtn.onclick = () => {
                        const url = DOM.canvas.urlInput.value;
                        if(url) {
                            DOM.canvas.iframe.srcdoc = ''; // Clear srcdoc if loading URL
                            DOM.canvas.iframe.src = url;
                        }
                    };

                    DOM.dashboardBackBtn.onclick = () => showView('home');
                    DOM.logoutBtn.onclick = () => signOut(auth);

                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    document.body.innerHTML = `<div class="bg-gray-900 text-white h-screen flex items-center justify-center p-4"><div class="text-center"><h1 class="text-2xl font-bold text-red-500">Connection Error</h1><p class="mt-2 text-gray-400">Could not connect to the database. Please verify your Firebase config and security rules.</p></div></div>`;
                }
            }
            
            function setupAuthForms() {
                DOM.loginSwitch.onclick = () => {
                    DOM.loginSwitch.classList.add('active', 'text-white', 'border-white'); 
                    DOM.registerSwitch.classList.remove('active', 'text-white', 'border-white');
                    DOM.loginForm.style.display = 'block'; DOM.registerForm.style.display = 'none';
                    DOM.authMessageBox.textContent = '';
                };
                DOM.registerSwitch.onclick = () => {
                    DOM.registerSwitch.classList.add('active', 'text-white', 'border-white'); 
                    DOM.loginSwitch.classList.remove('active', 'text-white', 'border-white');
                    DOM.registerForm.style.display = 'block'; DOM.loginForm.style.display = 'none';
                    DOM.authMessageBox.textContent = '';
                };
                DOM.loginForm.onsubmit = async (e) => {
                    e.preventDefault();
                    try { await signInWithEmailAndPassword(auth, DOM.loginForm.loginEmail.value, DOM.loginForm.loginPassword.value); } 
                    catch (error) { DOM.authMessageBox.textContent = error.message; }
                };
                DOM.registerForm.onsubmit = async (e) => {
                    e.preventDefault();
                    try { await createUserWithEmailAndPassword(auth, DOM.registerForm.registerEmail.value, DOM.registerForm.registerPassword.value); }
                    catch (error) { DOM.authMessageBox.textContent = error.message; }
                };

                DOM.devLoginBtn.onclick = async () => {
                    const devEmail = "developer@magog.ide";
                    const devPassword = "securepassword123";
                    DOM.authMessageBox.textContent = 'Attempting developer login...';
                    try {
                        await signInWithEmailAndPassword(auth, devEmail, devPassword);
                    } catch (error) {
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                            DOM.authMessageBox.textContent = 'Dev account not found. Creating it for you...';
                            try {
                                await createUserWithEmailAndPassword(auth, devEmail, devPassword);
                            } catch (creationError) {
                                DOM.authMessageBox.textContent = `Dev account creation failed: ${creationError.message}`;
                            }
                        } else {
                             DOM.authMessageBox.textContent = `Login failed: ${error.message}`;
                        }
                    }
                };

                DOM.loginSwitch.click();
            }

            function loadUserStorage() {
                currentDashboard = 'storage';
                DOM.dashboardTitle.textContent = "Geminus Storage";
                DOM.newItemBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>New Folder`;
                DOM.uploadStorageBtn.classList.remove('hidden');
                loadDashboardItems('storage');
            }
            
            function loadUserProjects() {
                currentDashboard = 'projects';
                DOM.dashboardTitle.textContent = "My Projects";
                DOM.newItemBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>New Project`;
                DOM.uploadStorageBtn.classList.add('hidden');
                loadDashboardItems('projects');
            }

            function loadDashboardItems(type, openGitPanel = false) {
                showView('dashboard');
                const itemsCollectionRef = collection(db, "users", userId, type);
                const q = query(itemsCollectionRef, orderBy("lastModified", "desc"));
                
                if (projectsListener) projectsListener(); 
                projectsListener = onSnapshot(q, snapshot => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (openGitPanel && type === 'projects') { // Git only for projects
                        if (items.length > 0) {
                            selectItem(items[0].id, items[0].name, true);
                        } else {
                            DOM.itemList.innerHTML = `<div class="col-span-full text-center text-gray-500 mt-10"><p>Create a project first to use the GitHub integration.</p></div>`;
                        }
                    } else {
                        renderDashboardList(items, type);
                    }
                });
            }

            function renderDashboardList(items, type) {
                DOM.itemList.innerHTML = '';
                if (items.length === 0) {
                    DOM.itemList.innerHTML = `<div class="col-span-full text-center text-gray-500 mt-10"><p>No ${type === 'projects' ? 'projects' : 'items'} yet.</p></div>`;
                } else {
                    items.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'project-card glassmorphism rounded-lg p-4 flex flex-col justify-between hover:border-white';
                        card.innerHTML = `
                            <div>
                                <h3 class="text-xl font-bold truncate">${item.name}</h3>
                                <p class="text-gray-400 text-sm mt-2">Last modified: ${item.lastModified ? new Date(item.lastModified.toDate()).toLocaleDateString() : 'N/A'}</p>
                            </div>
                            <div class="mt-4 space-y-2">
                                <button class="open-item-btn w-full btn-primary font-bold py-2 px-4 rounded-lg" data-item-id="${item.id}" data-item-name="${item.name}">Open</button>
                                <div class="flex space-x-2">
                                    <button class="rename-item-btn w-full btn-primary py-2 px-2 rounded-lg text-sm" data-item-id="${item.id}" data-item-name="${item.name}">Rename</button>
                                    <button class="delete-item-btn w-full bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-2 rounded-lg text-sm" data-item-id="${item.id}" data-item-name="${item.name}">Delete</button>
                                </div>
                            </div>
                        `;
                        DOM.itemList.appendChild(card);
                    });
                }
            }


            function handleCreateItem() {
                const isProject = currentDashboard === 'projects';
                const title = isProject ? 'Create New Project' : 'Create New Folder';
                const placeholder = isProject ? 'My Awesome Project' : 'My Game Notes';

                const content = `<input type="text" id="modalInput" class="w-full input-field rounded-md px-3 py-2" placeholder="${placeholder}">`;
                showModal(title, content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Create', class: 'px-4 py-2 rounded-md btn-primary text-sm', onClick: async (btn) => {
                        btn.disabled = true;
                        const name = document.getElementById('modalInput').value.trim();
                        if (!name) {
                            btn.disabled = false;
                            return;
                        }
                        try {
                            const collectionRef = collection(db, "users", userId, currentDashboard);
                            const newItemRef = await addDoc(collectionRef, { name, createdAt: serverTimestamp(), lastModified: serverTimestamp() });
                            
                            if (isProject) {
                                 await createDefaultProject(newItemRef.id);
                            }
                           
                            closeModal();
                            selectItem(newItemRef.id, name);
                        } catch (error) {
                            console.error("Error creating item:", error);
                            alert("Failed to create item. Please try again.");
                            btn.disabled = false;
                        }
                    }}
                ]);
            }
            
            function showModal(title, content, buttons) {
                DOM.modalContainer.innerHTML = `<div class="p-6 rounded-lg shadow-xl w-11/12 max-w-md glassmorphism"><h3 class="text-lg font-medium mb-4">${title}</h3><div>${content}</div><div class="mt-6 flex justify-end space-x-3">${buttons.map((b, i) => `<button id="modal-btn-${i}" class="${b.class}">${b.text}</button>`).join('')}</div></div>`;
                DOM.modalContainer.classList.remove('hidden');
                buttons.forEach((b, i) => document.getElementById(`modal-btn-${i}`).onclick = (e) => b.onClick(e.currentTarget));
                const input = DOM.modalContainer.querySelector('input');
                if (input) input.focus();
            }

            function closeModal() {
                DOM.modalContainer.classList.add('hidden');
                DOM.modalContainer.innerHTML = '';
            }

            function initEditor() {
                if (editor) return;
                editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                    lineNumbers: true,
                    theme: 'material-darker',
                    mode: 'htmlmixed',
                    indentUnit: 2,
                    tabSize: 2,
                    lineWrapping: true,
                    autoCloseBrackets: true,
                    extraKeys: {"Ctrl-Space": "autocomplete"},
                    hintOptions: { completeSingle: false },
                    gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers", "CodeMirror-foldgutter"],
                    lint: true,
                    foldGutter: true
                });
                
                editor.on("inputRead", function(cm, change) {
                    if (change.text[0] !== ';' && change.text[0] !== ' ') {
                       cm.showHint();
                    }
                });

                editor.on('change', () => {
                    if(focusEditor && DOM.views.focus.classList.contains('active')) {
                        focusEditor.setValue(editor.getValue());
                    }
                });
            }

            async function selectItem(itemId, itemName, openGitPanel = false) {
                currentProjectId = itemId;
                DOM.headerTitle.textContent = itemName;
                
                openTabs = [];
                activeTabId = null;

                showView('editor');
                initEditor();
                
                const isProject = currentDashboard === 'projects';
                DOM.runButton.style.display = isProject ? 'flex' : 'none';
                DOM.manageLibrariesBtn.style.display = isProject ? 'flex' : 'none';

                setupMobileNav();

                renderTabs(); 
                editor.setValue('');
                
                const collectionPath = `users/${userId}/${currentDashboard}/${currentProjectId}/files`;

                if (fileStructureUnsubscribe) fileStructureUnsubscribe();
                const filesCollectionRef = collection(db, collectionPath);
                fileStructureUnsubscribe = onSnapshot(filesCollectionRef, (snapshot) => {
                    fileStructure = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderFileTree();
                    if (openGitPanel) showPanel('gitPanel');
                });
                
                if (isProject) {
                    if (assetsUnsubscribe) assetsUnsubscribe();
                    const assetsCollectionRef = collection(db, `users/${userId}/projects/${currentProjectId}/assets`);
                    const assetsQuery = query(assetsCollectionRef, orderBy("uploadedAt", "desc"));
                    assetsUnsubscribe = onSnapshot(assetsQuery, (snapshot) => {
                        const assets = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        renderAssets(assets);
                    });
                }
            }

            async function createDefaultProject(projectId) {
                const batch = writeBatch(db);
                const projectDocRef = doc(db, 'users', userId, 'projects', projectId);
                const projectDoc = await getDoc(projectDocRef);
                const projectName = projectDoc.exists() ? projectDoc.data().name : 'My Project';
                const collectionPath = `users/${userId}/projects/${projectId}/files`;

                const filesCollectionRef = collection(db, collectionPath);
                batch.set(doc(filesCollectionRef), { name: 'index.html', type: 'file', parentId: 'root', content: `<!DOCTYPE html>\n<html>\n<head>\n  <title>${projectName}</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <h1>Hello, ${projectName}!</h1>\n  <script src="script.js"><\/script>\n</body>\n</html>`, isBinary: false });
                batch.set(doc(filesCollectionRef), { name: 'script.js', type: 'file', parentId: 'root', content: `console.log("Hello from ${projectName}!");`, isBinary: false });
                batch.set(doc(filesCollectionRef), { name: 'style.css', type: 'file', parentId: 'root', content: `body { font-family: sans-serif; }`, isBinary: false });
                
                await batch.commit();
            }

            function setupMobileNav() {
                const isProject = currentDashboard === 'projects';
                let navItems = [
                    { id: 'fileExplorerPanel', icon: 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z', label: 'Files' }, 
                    { id: 'searchPanel', icon: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z', label: 'Search'},
                    { id: 'editorPanel', icon: 'M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4', label: 'Editor' }, 
                    { id: 'snippetsPanel', icon: 'M13 10V3L4 14h7v7l9-11h-7z', label: 'Snippets'},
                    { id: 'aiPanel', icon: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z', label: 'AI'},
                ];
                if (isProject) {
                    navItems.splice(3, 0, { id: 'assetsPanel', icon: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1-1a2 2 0 01-2.828 0L8 12m0 0l-4 4m4-4V4m12 12v-4m0 4h-4m4 0l-4-4', label: 'Assets'});
                    navItems.push({ id: 'previewPanel', icon: 'M15 12a3 3 0 11-6 0 3 3 0 016 0zM2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z', label: 'Preview' });
                    navItems.push({ id: 'gitPanel', icon: 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0zM9 11a1 1 0 100-2 1 1 0 000 2z', label: 'Git' });
                }
                
                DOM.bottomNav.innerHTML = navItems.map(item => `<button data-panel="${item.id}" class="bottom-nav-btn flex-1 flex flex-col items-center justify-center h-full text-gray-400 border-t-2 border-transparent"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}" /></svg><span class="text-xs">${item.label}</span></button>`).join('');
                document.querySelectorAll('.bottom-nav-btn').forEach(btn => btn.addEventListener('click', () => showPanel(btn.dataset.panel)));
                showPanel('fileExplorerPanel');
            }

            function showPanel(panelId) {
                Object.values(DOM.editorPanels).forEach(p => {
                    if (p.id !== 'tabBar' && p.id !== 'editorWrapper' && p.id !== 'editorPlaceholder') {
                        p.classList.add('hidden');
                    }
                });

                if(DOM.editorPanels[panelId]) {
                     DOM.editorPanels[panelId].classList.remove('hidden');
                }

                if (window.innerWidth < 768) {
                    document.querySelectorAll('.bottom-nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.panel === panelId));
                }
                
                if (panelId === 'editorPanel' && editor) setTimeout(() => editor.refresh(), 1);
                if (panelId === 'previewPanel') runProject();
            }

            function renderFileTree() {
                DOM.fileTree.innerHTML = '';
                DOM.fileTree.appendChild(createTreeElement(buildTree(fileStructure, 'root')));
            }

            function buildTree(list, parentId) {
                const tree = [];
                list.filter(item => item.parentId === parentId).forEach(item => tree.push({ ...item, children: buildTree(list, item.id) }));
                return tree.sort((a, b) => (a.type === 'folder' && b.type === 'file') ? -1 : (a.type === 'file' && b.type === 'folder') ? 1 : a.name.localeCompare(b.name));
            }

            function createTreeElement(nodes) {
                const ul = document.createElement('ul');
                if (nodes.length === 0 && document.getElementById('fileTree').children.length === 0) {
                     ul.innerHTML = `<li class="text-gray-500 text-sm p-2">This folder is empty.</li>`;
                }
                nodes.forEach(node => {
                    const li = document.createElement('li');
                    const isFolder = node.type === 'folder';
                    
                    const itemContainer = document.createElement('div');
                    itemContainer.className = `${isFolder ? 'folder-item-container' : 'file-item-container'} flex items-center p-2 rounded-md`;
                    
                    const mainContent = document.createElement('div');
                    mainContent.className = 'flex-grow flex items-center cursor-pointer truncate';
                    
                    let iconHTML = isFolder ? `<svg class="h-5 w-5 mr-1 flex-shrink-0 text-gray-500 folder-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>` 
                                           : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`;
                    mainContent.innerHTML = `${iconHTML}<span class="truncate">${node.name}</span>`;
                    
                    const menuButton = document.createElement('button');
                    menuButton.className = 'item-menu-btn p-1 rounded-full flex-shrink-0';
                    menuButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>`;
                    
                    itemContainer.append(mainContent, menuButton);
                    li.appendChild(itemContainer);

                    mainContent.onclick = () => {
                        document.querySelectorAll('.file-item-container, .folder-item-container').forEach(el => el.classList.remove('selected'));
                        itemContainer.classList.add('selected');
                        if (isFolder) {
                            const folderContentDiv = li.querySelector('.folder-content');
                            const arrow = mainContent.querySelector('.folder-arrow');
                            folderContentDiv.classList.toggle('hidden');
                            arrow.classList.toggle('rotate-90');
                        } else { openFile(node.id); }
                    };

                    menuButton.onclick = (e) => {
                        e.stopPropagation();
                        const rect = e.currentTarget.getBoundingClientRect();
                        showContextMenu(rect.left, rect.bottom, node.id, node.name, node.type);
                    };

                    if (isFolder) {
                        const folderContentDiv = document.createElement('div');
                        folderContentDiv.className = 'folder-content hidden';
                        if (node.children.length > 0) {
                            folderContentDiv.appendChild(createTreeElement(node.children));
                        }
                        li.appendChild(folderContentDiv);
                    }
                    ul.appendChild(li);
                });
                return ul;
            }
            
            function openFile(fileId, line = 0, ch = 0) {
                const file = fileStructure.find(f => f.id === fileId);
                if (!file || file.type !== 'file') return;
                
                if (file.isBinary) {
                    handleDownload(fileId);
                    return;
                }

                if (!openTabs.some(tab => tab.id === fileId)) {
                    openTabs.push({ id: file.id, name: file.name });
                }

                activeTabId = fileId;
                renderTabs();

                const fileExtension = file.name.split('.').pop().toLowerCase();
                let mode = 'text/plain';
                
                switch(fileExtension) {
                    case 'html': mode = 'htmlmixed'; break;
                    case 'css': mode = 'css'; break;
                    case 'js': mode = 'javascript'; break;
                    case 'jsx': mode = 'jsx'; break;
                    case 'py': mode = 'python'; break;
                    case 'java':
                    case 'c':
                    case 'cpp':
                    case 'cs':
                        mode = 'text/x-csrc'; break;
                    case 'php': mode = 'php'; break;
                    case 'rb': mode = 'ruby'; break;
                    case 'go': mode = 'go'; break;
                    case 'sql': mode = 'sql'; break;
                    case 'json': mode = {name: "javascript", json: true}; break;
                    case 'md': mode = 'markdown'; break;
                }

                if (editor.getValue() !== (file.content || '')) {
                   editor.setValue(file.content || '');
                }
                
                editor.setOption('mode', mode);
                editor.setCursor({line, ch});
                editor.focus();
                
                if (window.innerWidth < 768) {
                    showPanel('editorPanel');
                }
            }

            async function saveData() {
                if (!currentProjectId || !activeTabId) return;
                const fileContent = editor.getValue();
                if (fileContent.length > 1048576) {
                    alert('Error: File is too large to save. Firestore documents have a 1MB limit.');
                    return;
                }
                DOM.saveButton.disabled = true; DOM.saveButton.textContent = 'Saving...';
                try {
                    const collectionPath = `users/${userId}/${currentDashboard}/${currentProjectId}/files`;
                    const fileDocRef = doc(db, collectionPath, activeTabId);
                    await updateDoc(fileDocRef, { content: fileContent });
                    
                    const itemDocRef = doc(db, "users", userId, currentDashboard, currentProjectId);
                    await updateDoc(itemDocRef, { lastModified: serverTimestamp() });

                    DOM.saveButton.textContent = 'Saved!'; DOM.saveButton.classList.add('bg-green-600');
                    setTimeout(() => { DOM.saveButton.textContent = 'Save'; DOM.saveButton.classList.remove('bg-green-600'); DOM.saveButton.disabled = false; }, 2000);
                } catch (error) {
                    console.error("Save Error:", error);
                    alert("Failed to save file. Check console for details.");
                    DOM.saveButton.textContent = 'Save'; DOM.saveButton.disabled = false;
                }
            }
            
            function runProject() {
                if (currentDashboard !== 'projects') {
                    alert("Run is only available for code projects.");
                    return;
                }
                const htmlFile = fileStructure.find(f => f.name === 'index.html');
                if (!htmlFile) {
                    DOM.previewFrame.srcdoc = `<html><body><h1 style="font-family: sans-serif; color: red;">Error: index.html not found!</h1></body></html>`;
                    return;
                }
                
                let htmlContent = htmlFile.content;
                const cssLinks = htmlContent.match(/<link.*?href="(.*?\.css)".*?>/g) || [];
                cssLinks.forEach(link => {
                    const href = link.match(/href="(.*?)"/)[1];
                    const cssFile = fileStructure.find(f => f.name === href);
                    if (cssFile) htmlContent = htmlContent.replace(link, `<style>${cssFile.content}</style>`);
                });

                const scriptSrcs = htmlContent.match(/<script.*?src="(.*?)"><\/script>/g) || [];
                scriptSrcs.forEach(scriptTag => {
                    const src = scriptTag.match(/src="(.*?)"/)[1];
                    const jsFile = fileStructure.find(f => f.name === src);
                    if (jsFile) htmlContent = htmlContent.replace(scriptTag, `<script>${jsFile.content}<\/script>`);
                });

                DOM.previewFrame.srcdoc = htmlContent;
                showPanel('previewPanel');
            }

            function showContextMenu(x, y, id, name, type) {
                hideContextMenu();
                let menuItems = '';
                if (type === 'folder') {
                    menuItems += `<div class="context-menu-item" data-action="newFile"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>New File</div>`;
                    menuItems += `<div class="context-menu-item" data-action="newFolder"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>New Folder</div>`;
                    if (currentDashboard === 'storage') {
                        menuItems += `<div class="context-menu-item" data-action="uploadInFolder"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>Upload File Here</div>`;
                    }
                    menuItems += `<div class="context-menu-divider"></div>`;
                }
                menuItems += `<div class="context-menu-item" data-action="rename"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>Rename</div>`;
                if (type === 'file') {
                     menuItems += `<div class="context-menu-item" data-action="download"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>Download</div>`;
                }
                menuItems += `<div class="context-menu-item delete" data-action="delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>Delete</div>`;
                
                DOM.contextMenu.innerHTML = menuItems;
                DOM.contextMenu.style.top = `0px`; DOM.contextMenu.style.left = `0px`;
                DOM.contextMenu.classList.remove('hidden');

                const menuWidth = DOM.contextMenu.offsetWidth; const menuHeight = DOM.contextMenu.offsetHeight;
                let finalX = x - menuWidth; let finalY = y;
                if (finalX < 0) finalX = x;
                if (finalY + menuHeight > window.innerHeight) finalY = y - menuHeight;
                
                DOM.contextMenu.style.left = `${finalX}px`; DOM.contextMenu.style.top = `${finalY}px`;
                
                DOM.contextMenu.querySelector('[data-action="rename"]').onclick = () => { hideContextMenu(); handleRenameFileOrFolder(id, name); };
                DOM.contextMenu.querySelector('[data-action="delete"]').onclick = () => { hideContextMenu(); handleDeleteFileOrFolder(id, name, type); };
                if (type === 'file') {
                    DOM.contextMenu.querySelector('[data-action="download"]').onclick = () => { hideContextMenu(); handleDownload(id); };
                }
                if (type === 'folder') {
                    DOM.contextMenu.querySelector('[data-action="newFile"]').onclick = () => { hideContextMenu(); handleNewFile(id); };
                    DOM.contextMenu.querySelector('[data-action="newFolder"]').onclick = () => { hideContextMenu(); handleNewFolder(id); };
                    if(currentDashboard === 'storage') {
                        DOM.contextMenu.querySelector('[data-action="uploadInFolder"]').onclick = () => { hideContextMenu(); DOM.storageUploader.setAttribute('data-parent-id', id); DOM.storageUploader.click(); };
                    }
                }
            }

            function hideContextMenu() { DOM.contextMenu.classList.add('hidden'); }

            function handleNewFile(parentId = 'root') {
                const content = `<input type="text" id="modalInput" class="w-full input-field rounded-md px-3 py-2 text-white" placeholder="e.g., app.js">`;
                showModal('Create New File', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Create', class: 'px-4 py-2 rounded-md btn-primary text-sm', onClick: async () => {
                        const name = document.getElementById('modalInput').value.trim();
                        if (!name) return;
                        const collectionPath = `users/${userId}/${currentDashboard}/${currentProjectId}/files`;
                        const filesCollectionRef = collection(db, collectionPath);
                        const isBinary = !TEXT_EDITABLE_EXTENSIONS.some(ext => name.endsWith(`.${ext}`));
                        await addDoc(filesCollectionRef, { name, type: 'file', parentId, content: '', isBinary });
                        closeModal();
                    }}
                ]);
            }

            function handleNewFolder(parentId = 'root') {
                const content = `<input type="text" id="modalInput" class="w-full input-field rounded-md px-3 py-2 text-white" placeholder="e.g., components">`;
                showModal('Create New Folder', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Create', class: 'px-4 py-2 rounded-md btn-primary text-sm', onClick: async () => {
                        const name = document.getElementById('modalInput').value.trim();
                        const collectionPath = `users/${userId}/${currentDashboard}/${currentProjectId}/files`;
                        const filesCollectionRef = collection(db, collectionPath);
                        if (name) await addDoc(filesCollectionRef, { name, type: 'folder', parentId: parentId });
                        closeModal();
                    }}
                ]);
            }
            
            async function handleDownload(fileId) {
                const file = fileStructure.find(f => f.id === fileId);
                if (!file) return;

                let blob;
                if (file.isBinary) {
                    const response = await fetch(file.content);
                    blob = await response.blob();
                } else {
                     blob = new Blob([file.content || ''], { type: getMimeType(file.name) });
                }
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = file.name;
                document.body.appendChild(a); a.click();
                document.body.removeChild(a); URL.revokeObjectURL(url);
            }
            
            function getMimeType(filename) {
                const extension = filename.split('.').pop().toLowerCase();
                const mimeTypes = { html: 'text/html', css: 'text/css', js: 'application/javascript', json: 'application/json', png: 'image/png', jpg: 'image/jpeg', jpeg: 'image/jpeg', pdf: 'application/pdf', doc: 'application/msword', docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' };
                return mimeTypes[extension] || 'application/octet-stream';
            }

            // --- Tabbed Editor Logic ---
            function renderTabs() {
                const { tabBar, editorWrapper, editorPlaceholder } = DOM.editorPanels;
                tabBar.innerHTML = ''; 

                if (openTabs.length === 0) {
                    editorWrapper.classList.add('hidden');
                    editorPlaceholder.classList.remove('hidden');
                    return;
                }

                editorWrapper.classList.remove('hidden');
                editorPlaceholder.classList.add('hidden');

                openTabs.forEach(tab => {
                    const tabEl = document.createElement('div');
                    tabEl.className = 'tab-item';
                    if (tab.id === activeTabId) {
                        tabEl.classList.add('active');
                    }
                    tabEl.dataset.fileId = tab.id;
                    tabEl.innerHTML = `
                        <span>${tab.name}</span>
                        <button class="tab-close-btn" title="Close Tab">
                            <svg class="w-4 h-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    `;
                    
                    tabEl.addEventListener('click', (e) => {
                        if (!e.target.closest('.tab-close-btn')) {
                            openFile(tab.id);
                        }
                    });

                    tabEl.querySelector('.tab-close-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        closeTab(tab.id);
                    });

                    tabBar.appendChild(tabEl);
                });
            }

            function closeTab(fileIdToClose) {
                const index = openTabs.findIndex(tab => tab.id === fileIdToClose);
                if (index === -1) return;

                openTabs.splice(index, 1);

                if (activeTabId === fileIdToClose) {
                    if (openTabs.length > 0) {
                        const newActiveIndex = Math.max(0, index - 1);
                        const newActiveTab = openTabs[newActiveIndex];
                        openFile(newActiveTab.id);
                    } else {
                        activeTabId = null;
                        editor.setValue('');
                        renderTabs();
                    }
                } else {
                    renderTabs();
                }
            }

            // --- Git Logic (Simulated) ---
            async function checkGitConnection() {
                const userDocRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userDocRef);
                const userData = userDoc.data();
                if (userData && userData.githubToken) {
                    const token = userData.githubToken;
                    const userInfo = await verifyGitHubToken(token);
                    if (userInfo) {
                        showGitMainView(userInfo);
                    } else {
                        await disconnectFromGit();
                    }
                } else {
                    showGitConnectView();
                }
            }
            
            async function connectToGit() {
                const token = DOM.git.patInput.value.trim();
                if (!token) {
                    alert('Please enter a Personal Access Token.');
                    return;
                }
                const btn = DOM.git.connectBtn;
                btn.disabled = true;
                btn.textContent = 'Connecting...';

                const userInfo = await verifyGitHubToken(token);
                if (userInfo) {
                    const userDocRef = doc(db, 'users', userId);
                    await setDoc(userDocRef, { githubToken: token }, { merge: true });
                    showGitMainView(userInfo);
                    DOM.git.patInput.value = '';
                } else {
                    alert('Invalid or expired token. Please check your token and try again.');
                }
                btn.disabled = false;
                btn.textContent = 'Connect';
            }
            
            async function verifyGitHubToken(token) {
                try {
                    const response = await fetch('https://api.github.com/user', {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    if (response.ok) {
                        return await response.json();
                    }
                    return null;
                } catch (error) {
                    console.error('Error verifying GitHub token:', error);
                    return null;
                }
            }

            async function disconnectFromGit() {
                const userDocRef = doc(db, 'users', userId);
                await updateDoc(userDocRef, { 
                    githubToken: deleteField() 
                });
                showGitConnectView();
            }

            function showGitConnectView() {
                DOM.git.connectView.classList.remove('hidden');
                DOM.git.mainView.classList.add('hidden');
            }

            function showGitMainView(userInfo) {
                DOM.git.avatar.src = userInfo.avatar_url;
                DOM.git.username.textContent = userInfo.login;
                DOM.git.connectView.classList.add('hidden');
                DOM.git.mainView.classList.remove('hidden');
                getGitStatus();
            }

            function getGitStatus() {
                // SIMULATION
                gitChangedFiles = [
                    { name: 'index.html', status: 'M' },
                    { name: 'style.css', status: 'M' },
                ];
                gitStagedFiles = [
                    { name: 'script.js', status: 'A' }
                ];
                renderGitStatus();
            }

            function renderGitStatus() {
                DOM.git.changesList.innerHTML = gitChangedFiles.length > 0 ? gitChangedFiles.map(file => `
                    <div class="git-file-item">
                        <span>${file.name}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-yellow-400 font-bold">${file.status}</span>
                            <button title="Stage Change" class="git-action-btn stage-btn" data-filename="${file.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                `).join('') : `<p class="text-gray-500 text-sm">No changes.</p>`;
                
                DOM.git.stagedList.innerHTML = gitStagedFiles.length > 0 ? gitStagedFiles.map(file => `
                       <div class="git-file-item">
                            <span>${file.name}</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-400 font-bold">${file.status}</span>
                                <button title="Unstage Change" class="git-action-btn unstage-btn" data-filename="${file.name}">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                    </div>
                `).join('') : `<p class="text-gray-500 text-sm">No staged changes.</p>`;
            }

            function stageFile(filename) {
                const fileIndex = gitChangedFiles.findIndex(f => f.name === filename);
                if (fileIndex > -1) {
                    const [fileToStage] = gitChangedFiles.splice(fileIndex, 1);
                    gitStagedFiles.push(fileToStage);
                    renderGitStatus();
                }
            }

            function unstageFile(filename) {
                const fileIndex = gitStagedFiles.findIndex(f => f.name === filename);
                if (fileIndex > -1) {
                    const [fileToUnstage] = gitStagedFiles.splice(fileIndex, 1);
                    gitChangedFiles.push(fileToUnstage);
                    renderGitStatus();
                }
            }
            
            function handleCommit() {
                const message = DOM.git.commitMessage.value.trim();
                if (!message) {
                    alert('Please enter a commit message.');
                    return;
                }
                if (gitStagedFiles.length === 0) {
                    alert('There are no changes staged for commit.');
                    return;
                }
                
                console.log(`Committing ${gitStagedFiles.length} files with message: "${message}"`);
                alert(`Commit successful!\n\nMessage: "${message}"`);
                
                gitStagedFiles = [];
                DOM.git.commitMessage.value = '';
                renderGitStatus();
                DOM.git.commitHistory.innerHTML = `<p class="text-gray-400">Successfully committed "${message}"</p>` + DOM.git.commitHistory.innerHTML;
            }
            
            // --- Asset Management ---
            function renderAssets(assets) {
                 DOM.assets.list.innerHTML = assets.length > 0 ? assets.map(asset => {
                    const isImage = asset.type.startsWith('image/');
                    const isSvg = asset.name.endsWith('.svg');
                    let previewHTML = '';

                    if (isImage) {
                        previewHTML = `<img src="${asset.content}" class="max-w-full max-h-full object-contain">`;
                    } else if (isSvg) {
                        previewHTML = `<div class="asset-svg-wrapper">${asset.content}</div>`;
                    } else {
                        previewHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                            <p class="text-xs text-gray-300 truncate w-full text-center mt-2 absolute bottom-2 px-1">${asset.name}</p>`;
                    }

                     return `
                     <div class="relative group aspect-square flex flex-col items-center justify-center bg-gray-900 rounded-lg p-2 overflow-hidden border border-gray-700">
                         ${previewHTML}
                         <div class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                             <button class="copy-asset-content-btn text-white btn-primary px-3 py-1 rounded-md text-sm" data-content="${encodeURIComponent(asset.content)}">Copy Content</button>
                         </div>
                         <button class="delete-asset-btn" data-asset-id="${asset.id}" data-asset-name="${asset.name}" title="Delete Asset">
                             <svg class="w-5 h-5 text-white pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                         </button>
                     </div>
                `}).join('') : `<p class="text-gray-500 text-sm col-span-full text-center">No assets uploaded yet.</p>`;
            }

            async function handleAssetUpload(e) {
                const file = e.target.files[0];
                if (!file || !currentProjectId) return;
                
                const isImage = file.type.startsWith('image/');
                const reader = new FileReader();

                reader.onload = async (event) => {
                    const content = event.target.result;
                    try {
                        const collectionPath = `users/${userId}/${currentDashboard}/${currentProjectId}/assets`;
                        const assetsCollectionRef = collection(db, collectionPath);
                        await addDoc(assetsCollectionRef, {
                            name: file.name,
                            type: file.type || 'application/octet-stream',
                            content: content,
                            uploadedAt: serverTimestamp()
                        });
                    } catch (error) {
                        console.error("Asset upload error:", error);
                        alert("Error uploading asset to Firestore. It may be too large. Check console for details.");
                    }
                };
                reader.onerror = (error) => {
                    console.error("File reading error:", error);
                    alert("Could not read the selected file.");
                };
                
                if (isImage) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
                
                DOM.assetUploader.value = ''; 
            }
            
            function handleDeleteAsset(assetId, assetName) {
                const content = `<p>Are you sure you want to delete asset <strong class="font-bold">${assetName}</strong>? This cannot be undone.</p>`;
                showModal('Delete Asset', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Delete', class: 'px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 text-sm', onClick: async () => {
                        try {
                            const collectionPath = `users/${userId}/${currentDashboard}/${currentProjectId}/assets`;
                            const assetDocRef = doc(db, collectionPath, assetId);
                            await deleteDoc(assetDocRef);
                            closeModal();
                        } catch(error) {
                            console.error("Error deleting asset:", error);
                            alert("Failed to delete asset. Please try again.");
                        }
                    }}
                ]);
            }

            // --- AI Assistant ---
            async function handleAIAssist(userPrompt) {
                if (!userPrompt.trim()) return;

                addMessageToAIChat(userPrompt, 'user');
                addMessageToAIChat('...', 'assistant', true); 

                const codeContext = editor.getSelection() || editor.getValue();
                const fullPrompt = `
                    You are an expert code assistant.
                    Here is the current code I'm working on:
                    \`\`\`
                    ${codeContext}
                    \`\`\`
                    Please help me with the following request: ${userPrompt}
                `;
                
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: fullPrompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API error: ${response.statusText} - ${errorBody}`);
                    }

                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    
                    updateLastAIChatMessage(text);

                } catch (error) {
                    console.error("AI Assistant Error:", error);
                    updateLastAIChatMessage(`Sorry, I encountered an error. Please check the console for details.`);
                }
            }

            function addMessageToAIChat(content, role, isLoading = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ${role}`;
                if (isLoading) {
                    messageDiv.id = 'ai-loading-indicator';
                    messageDiv.innerHTML = `<div class="animate-pulse">● ● ●</div>`;
                } else {
                    content = content.replace(/```(\w+)?\n([\s\S]+?)```/g, '<pre class="bg-black p-2 rounded-md my-2"><code>$2</code></pre>');
                    messageDiv.innerHTML = content;
                }
                DOM.ai.chatContainer.appendChild(messageDiv);
                DOM.ai.chatContainer.scrollTop = DOM.ai.chatContainer.scrollHeight;
            }
            
            function updateLastAIChatMessage(content) {
                const loadingIndicator = document.getElementById('ai-loading-indicator');
                if (loadingIndicator) {
                    content = content.replace(/```(\w+)?\n([\s\S]+?)```/g, '<pre class="bg-black p-2 rounded-md my-2"><code>$2</code></pre>');
                    loadingIndicator.innerHTML = content;
                    loadingIndicator.removeAttribute('id');
                }
            }
            
            // --- Project Search ---
            function handleProjectSearch() {
                const query = DOM.search.input.value.trim().toLowerCase();
                if (!query) {
                    DOM.search.results.innerHTML = '';
                    return;
                }
                
                let resultsHTML = '';
                let resultCount = 0;

                fileStructure.filter(f => f.type === 'file' && f.content && !f.isBinary).forEach(file => {
                    const lines = file.content.split('\n');
                    let fileResultsHTML = '';
                    
                    lines.forEach((line, index) => {
                        if (line.toLowerCase().includes(query)) {
                            resultCount++;
                            const highlightedLine = line.replace(new RegExp(query, 'gi'), `<span class="match">${query}</span>`);
                            fileResultsHTML += `
                                <div class="search-result-item p-2 rounded-md" data-fileid="${file.id}" data-line="${index}">
                                    <span class="text-gray-500 mr-2">${index + 1}:</span>
                                    <span class="font-mono text-sm">${highlightedLine.trim()}</span>
                                </div>
                            `;
                        }
                    });

                    if (fileResultsHTML) {
                        resultsHTML += `
                            <div class="mb-4">
                                <h4 class="font-bold text-gray-300">${file.name}</h4>
                                ${fileResultsHTML}
                            </div>
                        `;
                    }
                });

                if (resultCount === 0) {
                    resultsHTML = `<p class="text-gray-500">No results found for "${DOM.search.input.value}".</p>`;
                }
                
                DOM.search.results.innerHTML = resultsHTML;
            }

            // --- Snippets ---
            function listenForSnippets() {
                if (snippetsUnsubscribe) snippetsUnsubscribe();
                const snippetsCollectionRef = collection(db, "users", userId, "snippets");
                const q = query(snippetsCollectionRef, orderBy("name"));
                snippetsUnsubscribe = onSnapshot(q, snapshot => {
                    const snippets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSnippets(snippets);
                });
            }

            function renderSnippets(snippets) {
                DOM.snippets.list.innerHTML = snippets.length > 0 ? snippets.map(snippet => `
                    <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                        <span class="font-mono text-gray-300">${snippet.name}</span>
                        <button class="insert-snippet-btn btn-primary text-xs px-3 py-1 rounded-md" data-id="${snippet.id}">Insert</button>
                    </div>
                `).join('') : `<p class="text-gray-500 text-sm text-center">No snippets saved yet.</p>`;
            }

            function handleCreateSnippet() {
                const content = `
                    <div class="space-y-4">
                        <div>
                            <label for="snippetName" class="block text-sm font-medium text-gray-300">Snippet Name</label>
                            <input type="text" id="snippetName" class="mt-1 block w-full input-field rounded-md p-2" placeholder="e.g., gameloop">
                        </div>
                        <div>
                            <label for="snippetCode" class="block text-sm font-medium text-gray-300">Snippet Code</label>
                            <textarea id="snippetCode" class="mt-1 block w-full input-field rounded-md p-2 font-mono" rows="6"></textarea>
                        </div>
                    </div>`;
                showModal('Create New Snippet', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Save', class: 'px-4 py-2 rounded-md btn-primary text-sm', onClick: async () => {
                        const name = document.getElementById('snippetName').value.trim();
                        const code = document.getElementById('snippetCode').value.trim();
                        if (name && code) {
                            const snippetsCollectionRef = collection(db, "users", userId, "snippets");
                            await addDoc(snippetsCollectionRef, { name, code });
                        }
                        closeModal();
                    }}
                ]);
            }
            
            async function insertSnippet(snippetId) {
                if (!editor) {
                    alert("Please open a file in the editor first.");
                    return;
                }
                const snippetDocRef = doc(db, "users", userId, "snippets", snippetId);
                const snippetDoc = await getDoc(snippetDocRef);
                if (snippetDoc.exists()) {
                    editor.replaceSelection(snippetDoc.data().code);
                    showPanel('editorPanel');
                }
            }
            
            // --- File Upload Handlers ---
            function handleProjectFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const content = event.target.result;
                    const collectionPath = `users/${userId}/projects/${currentProjectId}/files`;
                    const filesCollectionRef = collection(db, collectionPath);
                    await addDoc(filesCollectionRef, {
                        name: file.name,
                        type: 'file',
                        parentId: 'root', 
                        content: content,
                        isBinary: false
                    });
                };
                reader.readAsText(file);
                DOM.fileUploader.value = '';
            }

            function handleStorageUpload(e) {
                const files = e.target.files;
                if (!files.length || !currentProjectId) return;
                
                const parentId = e.target.getAttribute('data-parent-id') || 'root';
                e.target.removeAttribute('data-parent-id');

                for (const file of files) {
                    const reader = new FileReader();
                    const isBinary = !TEXT_EDITABLE_EXTENSIONS.some(ext => file.name.endsWith(`.${ext}`));

                    reader.onload = async (event) => {
                        const content = event.target.result;
                        const collectionPath = `users/${userId}/storage/${currentProjectId}/files`;
                        const filesCollectionRef = collection(db, collectionPath);
                        try {
                            await addDoc(filesCollectionRef, {
                                name: file.name,
                                type: 'file',
                                parentId: parentId,
                                content: content,
                                isBinary: isBinary,
                                fileType: file.type || 'application/octet-stream'
                            });
                        } catch (error) {
                            console.error("Error uploading file to storage:", error);
                            alert(`Failed to upload ${file.name}. It might be too large for storage.`);
                        }
                    };

                    if (isBinary) {
                        reader.readAsDataURL(file);
                    } else {
                        reader.readAsText(file);
                    }
                }
                DOM.storageUploader.value = '';
            }


            // --- Project/File Management Handlers ---
            function handleRenameFileOrFolder(id, oldName) {
                const content = `<input type="text" id="modalInput" value="${oldName}" class="w-full input-field rounded-md px-3 py-2 text-white">`;
                showModal(`Rename`, content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Rename', class: 'px-4 py-2 rounded-md btn-primary text-sm', onClick: async () => {
                        const newName = document.getElementById('modalInput').value.trim();
                        if (newName && newName !== oldName) {
                            const collectionPath = `users/${userId}/${currentDashboard}/${currentProjectId}/files`;
                            const itemDocRef = doc(db, collectionPath, id);
                            await updateDoc(itemDocRef, { name: newName });
                        }
                        closeModal();
                    }}
                ]);
            }

            async function deleteFolderContents(folderId, batch) {
                const children = fileStructure.filter(f => f.parentId === folderId);
                for (const child of children) {
                    const docRef = doc(db, `users/${userId}/${currentDashboard}/${currentProjectId}/files`, child.id);
                    batch.delete(docRef);
                    if (child.type === 'folder') {
                        await deleteFolderContents(child.id, batch); // Recurse for sub-folders
                    } else {
                        closeTab(child.id); // Close tab if it's an open file
                    }
                }
            }
            
            async function handleDeleteFileOrFolder(id, name, type) {
                const title = type === 'folder' ? 'Delete Folder' : 'Delete File';
                const message = type === 'folder'
                    ? `<p>Are you sure you want to permanently delete the folder <strong class="font-bold">${name}</strong> and all of its contents? This cannot be undone.</p>`
                    : `<p>Are you sure you want to permanently delete the file <strong class="font-bold">${name}</strong>? This cannot be undone.</p>`;

                showModal(title, message, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Delete', class: 'px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 text-sm', onClick: async (btn) => {
                        btn.disabled = true;
                        btn.textContent = 'Deleting...';
                        try {
                            const collectionPath = `users/${userId}/${currentDashboard}/${currentProjectId}/files`;

                            if (type === 'file') {
                                const fileDocRef = doc(db, collectionPath, id);
                                await deleteDoc(fileDocRef);
                                closeTab(id);
                            } else { // type === 'folder'
                                const batch = writeBatch(db);
                                await deleteFolderContents(id, batch);
                                const folderDocRef = doc(db, collectionPath, id);
                                batch.delete(folderDocRef);
                                await batch.commit();
                            }
                            closeModal();
                        } catch (error) {
                             console.error("Error deleting item:", error);
                             alert("Failed to delete item. Please check the console and try again.");
                             btn.disabled = false;
                             btn.textContent = 'Delete';
                        }
                    }}
                ]);
            }

            function handleDeleteProjectOrStorageItem(itemId, itemName) {
                const content = `<p>Are you sure you want to permanently delete <strong class="font-bold">${itemName}</strong> and all of its contents? This cannot be undone.</p>`;
                showModal('Delete Item', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Delete', class: 'px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 text-sm', onClick: async (btn) => {
                        btn.disabled = true;
                        btn.textContent = 'Deleting...';
                        try {
                            const itemDocRef = doc(db, "users", userId, currentDashboard, itemId);
                            
                            const collectionsToDelete = ['files', 'assets'];
                            for (const subCollection of collectionsToDelete) {
                                const subCollectionRef = collection(db, `users/${userId}/${currentDashboard}/${itemId}/${subCollection}`);
                                const snapshot = await getDocs(subCollectionRef);
                                if (!snapshot.empty) {
                                    const batch = writeBatch(db);
                                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                                    await batch.commit();
                                }
                            }
                            
                            await deleteDoc(itemDocRef);
                            closeModal();
                        } catch (error) {
                            console.error("Error deleting project/item:", error);
                            alert("Failed to delete project. Please check the console and try again.");
                            btn.disabled = false;
                            btn.textContent = 'Delete';
                        }
                    }}
                ]);
            }

            // --- Focus Mode Logic ---
            function enterFocusMode() {
                if (!editor || !activeTabId) return;

                if (!focusEditor) {
                    focusEditor = CodeMirror(DOM.focus.editorWrapper, { ...editor.options });
                     focusEditor.on('change', () => {
                        if(editor && !DOM.views.focus.classList.contains('hidden')) {
                            editor.setValue(focusEditor.getValue());
                        }
                    });
                }
                
                focusEditor.setValue(editor.getValue());
                focusEditor.setOption('mode', editor.getOption('mode'));
                
                DOM.views.focus.classList.remove('hidden');
                DOM.views.focus.classList.add('active');

                setTimeout(() => focusEditor.refresh(), 1);
            }

            function exitFocusMode() {
                DOM.views.focus.classList.add('hidden');
                DOM.views.focus.classList.remove('active');

                if (editor) {
                    editor.setValue(focusEditor.getValue());
                    editor.focus();
                    setTimeout(() => editor.refresh(), 1);
                }
            }

            function handleFocusDoubleTap(e) {
                const now = new Date().getTime();
                const touch = e.changedTouches[0];
                const tapX = touch.clientX;
                const tapY = touch.clientY;

                if (now - lastTapTime < 300 && Math.abs(tapX - lastTapX) < 30 && Math.abs(tapY - lastTapY) < 30) {
                    e.preventDefault();
                    const rect = e.currentTarget.getBoundingClientRect();
                    const x = tapX - rect.left;
                    const y = tapY - rect.top;
                    const cornerSize = 100;

                    const isTop = y < cornerSize;
                    const isBottom = y > rect.height - cornerSize;
                    const isLeft = x < cornerSize;
                    const isRight = x > rect.width - cornerSize;

                    let content = null;
                    let position = {};
                    
                    if (isTop && isLeft) { 
                        content = DOM.editorPanels.fileExplorerPanel.cloneNode(true);
                        position = { top: '1rem', left: '1rem' };
                    } else if (isBottom && isLeft) { 
                        content = DOM.bottomNav.cloneNode(true);
                        position = { bottom: '1rem', left: '1rem', right: '1rem' };
                        content.style.height = 'auto';
                    } else if (isTop && isRight) { 
                        const settingsEl = document.createElement('div');
                        settingsEl.innerHTML = `<h3 class="text-lg font-bold p-4">Settings</h3><p class="p-4 text-gray-400">Settings panel will be here.</p>`;
                        content = settingsEl;
                        position = { top: '1rem', right: '1rem' };
                    } else if (isBottom && isRight) { 
                        content = DOM.editorPanels.aiPanel.cloneNode(true);
                        position = { bottom: '1rem', right: '1rem' };
                    }
                    
                    if (content) {
                        showFocusPopup(content, position);
                    }
                }
                lastTapTime = now;
                lastTapX = tapX;
                lastTapY = tapY;
            }


            function showFocusPopup(contentElement, position) {
                document.querySelectorAll('.focus-ui-popup').forEach(p => p.remove());

                const popup = document.createElement('div');
                popup.className = 'focus-ui-popup';
                Object.assign(popup.style, position);

                popup.appendChild(contentElement);
                DOM.views.focus.appendChild(popup);

                setTimeout(() => {
                    const closeHandler = (e) => {
                         if (!popup.contains(e.target)) {
                            popup.remove();
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    document.addEventListener('click', closeHandler);
                }, 100);
            }
            
            // --- Library Manager ---
            function handleManageLibraries() {
                const indexHtml = fileStructure.find(f => f.name === 'index.html');
                if (!indexHtml) {
                    alert('Could not find index.html in this project. Please create one first.');
                    return;
                }
                const currentContent = indexHtml.content || '';

                const librariesHtml = Object.entries(JS_LIBRARIES).map(([name, url]) => {
                    const isChecked = currentContent.includes(url);
                    return `
                        <label class="flex items-center space-x-3 p-2 hover:bg-gray-700 rounded-md">
                            <input type="checkbox" name="library" value="${name}" class="form-checkbox h-5 w-5 bg-gray-800 border-gray-600 text-gray-400 focus:ring-0" ${isChecked ? 'checked' : ''}>
                            <span class="text-white">${name}</span>
                        </label>
                    `;
                }).join('');

                const modalContent = `<div class="space-y-2 max-h-64 overflow-y-auto">${librariesHtml}</div>`;

                showModal('Manage JavaScript Libraries', modalContent, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Inject Scripts', class: 'px-4 py-2 rounded-md btn-primary text-sm', onClick: async () => {
                        const selectedLibs = Array.from(document.querySelectorAll('input[name="library"]:checked')).map(cb => cb.value);
                        await injectLibraries(selectedLibs);
                        closeModal();
                    }}
                ]);
            }

            async function injectLibraries(selectedLibs) {
                 const indexHtmlFile = fileStructure.find(f => f.name === 'index.html');
                 if (!indexHtmlFile) return;

                 let content = indexHtmlFile.content || '';
                 
                 Object.values(JS_LIBRARIES).forEach(url => {
                    const scriptTagRegex = new RegExp(`<script src="${url.replace('.', '\\.')}"><\/script>\\n?`);
                    content = content.replace(scriptTagRegex, '');
                 });

                 const scriptsToInject = selectedLibs.map(libName => `  <script src="${JS_LIBRARIES[libName]}"><\/script>`).join('\n');

                 if(scriptsToInject) {
                    if (content.includes('</head>')) {
                        content = content.replace('</head>', `${scriptsToInject}\n</head>`);
                    } else {
                        content = `${scriptsToInject}\n` + content;
                    }
                 }
                 
                 const fileDocRef = doc(db, `users/${userId}/projects/${currentProjectId}/files`, indexHtmlFile.id);
                 await updateDoc(fileDocRef, { content });

                 if(activeTabId === indexHtmlFile.id) {
                     editor.setValue(content);
                 }
                 alert('Libraries updated in index.html!');
            }


            // --- Event Listeners ---
            DOM.newItemBtn.onclick = handleCreateItem;
            DOM.uploadStorageBtn.onclick = () => {
                DOM.storageUploader.setAttribute('data-parent-id', 'root');
                DOM.storageUploader.click();
            }
            DOM.backToDashboardBtn.onclick = () => {
                if (currentDashboard === 'projects') loadUserProjects();
                else loadUserStorage();
            };
            DOM.manageLibrariesBtn.onclick = handleManageLibraries;
            DOM.saveButton.onclick = saveData;
            DOM.runButton.onclick = runProject;
            DOM.uploadFileBtn.onclick = () => DOM.fileUploader.click();
            DOM.fileUploader.onchange = handleProjectFileUpload;
            DOM.storageUploader.onchange = handleStorageUpload;
            DOM.newFileBtn.onclick = () => handleNewFile('root');
            DOM.newFolderBtn.onclick = () => handleNewFolder('root');
            DOM.git.connectBtn.onclick = connectToGit;
            DOM.git.disconnectBtn.onclick = disconnectFromGit;
            DOM.git.commitBtn.onclick = handleCommit;
            DOM.git.pushBtn.onclick = () => alert("Simulating a push to the remote repository!");
            DOM.git.pullBtn.onclick = () => alert("Simulating a pull from the remote repository!");
            DOM.assets.uploadBtn.onclick = () => DOM.assetUploader.click();
            DOM.assets.newFolderBtn.onclick = () => alert("Asset folder creation coming soon!");
            DOM.assetUploader.onchange = handleAssetUpload;
            DOM.ai.sendBtn.onclick = () => {
                handleAIAssist(DOM.ai.input.value);
                DOM.ai.input.value = '';
            };
            DOM.ai.input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    handleAIAssist(DOM.ai.input.value);
                    DOM.ai.input.value = '';
                }
            };
            DOM.ai.actionBtns.forEach(btn => {
                btn.onclick = () => handleAIAssist(btn.dataset.prompt);
            });
            DOM.search.btn.onclick = handleProjectSearch;
            DOM.search.input.onkeydown = (e) => {
                if (e.key === 'Enter') handleProjectSearch();
            };
            DOM.search.results.addEventListener('click', (e) => {
                const item = e.target.closest('.search-result-item');
                if (item) {
                    const { fileid, line } = item.dataset;
                    openFile(fileid, parseInt(line));
                }
            });
            DOM.snippets.newBtn.onclick = handleCreateSnippet;
            DOM.snippets.list.addEventListener('click', e => {
                if (e.target.classList.contains('insert-snippet-btn')) {
                    insertSnippet(e.target.dataset.id);
                }
            });
            DOM.focus.enterBtn.onclick = enterFocusMode;
            DOM.focus.exitBtn.onclick = exitFocusMode;
            DOM.views.focus.addEventListener('touchend', handleFocusDoubleTap);

            DOM.itemList.addEventListener('click', e => {
                const openBtn = e.target.closest('.open-item-btn');
                const renameBtn = e.target.closest('.rename-item-btn');
                const deleteBtn = e.target.closest('.delete-item-btn');

                if (openBtn) {
                    selectItem(openBtn.dataset.itemId, openBtn.dataset.itemName);
                } else if (renameBtn) {
                    handleRenameFileOrFolder(renameBtn.dataset.itemId, renameBtn.dataset.itemName);
                } else if (deleteBtn) {
                    handleDeleteProjectOrStorageItem(deleteBtn.dataset.itemId, deleteBtn.dataset.itemName);
                }
            });

            DOM.assets.list.addEventListener('click', e => {
                const copyBtn = e.target.closest('.copy-asset-content-btn');
                const deleteBtn = e.target.closest('.delete-asset-btn');

                if (copyBtn) {
                    const content = decodeURIComponent(copyBtn.dataset.content);
                    const textArea = document.createElement('textarea');
                    textArea.value = content;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy Content', 2000);
                    } catch (err) {
                        console.error('Fallback: Oops, unable to copy', err);
                    }
                    document.body.removeChild(textArea);
                } else if (deleteBtn) {
                    handleDeleteAsset(deleteBtn.dataset.assetId, deleteBtn.dataset.assetName);
                }
            });

            DOM.git.mainView.addEventListener('click', (e) => {
                if (e.target.closest('.stage-btn')) {
                    stageFile(e.target.closest('.stage-btn').dataset.filename);
                }
                if (e.target.closest('.unstage-btn')) {
                    unstageFile(e.target.closest('.unstage-btn').dataset.filename);
                }
            });

            document.onclick = (e) => {
                if (!DOM.contextMenu.contains(e.target) && !e.target.closest('.item-menu-btn')) {
                    hideContextMenu();
                }
            };
            
            main();
        });
    </script>
</body>
</html>



